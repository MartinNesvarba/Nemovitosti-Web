<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Správa obsahu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Editor textu TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/t62v88urbx396otieiqu7apcy81f9ulf00f3eb24ym4s0x2c/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <!-- Knihovny pro ZIP a stahování (Pro funkci Vodoznak) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Custom Tailwind directives */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        @layer components {
            .btn { @apply font-bold py-2 px-4 rounded transition duration-200; }
            .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white disabled:bg-blue-400; }
            .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
            .btn-danger { @apply bg-red-500 hover:bg-red-700 text-white; }
            /* Tlačítko pro stahování fotek */
            .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
            /* Tlačítko pro AI */
            .btn-ai { @apply bg-purple-600 hover:bg-purple-700 text-white shadow-lg hover:shadow-xl transform hover:-translate-y-0.5; }
            
            .table-header { @apply px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap; }
            .table-cell { @apply px-5 py-5 border-b border-gray-200 bg-white text-sm align-middle text-center; }
            .input-field { @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline; }
            .sidebar-link { @apply block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700; }
            .sidebar-link.active { @apply bg-gray-600 font-bold; }
            .tab-button { @apply px-4 py-2 font-semibold text-gray-600 rounded-t-lg transition-colors duration-200; }
            .tab-button.active { @apply bg-white text-blue-600 border-b-2 border-blue-600; }
            .status-toggle { @apply cursor-pointer font-bold py-1 px-3 rounded-full text-xs; }
            .status-toggle.active { @apply bg-green-100 text-green-800; }
            .status-toggle.inactive { @apply bg-red-100 text-red-800; }
        }
        
        .hidden { display: none; }
        .error-message { color: #D8000C; background-color: #FFD2D2; border: 1px solid #D8000C; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        
        /* Styly pro náhledy obrázků */
        .image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 0.5rem; }
        .remove-image-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* Checkboxy vlastností */
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .feature-item { @apply flex items-center; }
        .feature-item input { @apply w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500; }
        .feature-item label { @apply ml-2 text-sm font-medium text-gray-900; }
        
        .lang-tab-content { display: none; }
        .lang-tab-content.active { display: block; }
        
        #tags-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 0.5rem;
        }

        /* --- DRAG & DROP STYLES --- */
        .drop-zone-container {
            border: 2px dashed #dde2e5;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #fafbfc;
            transition: border-color 0.2s, background-color 0.2s;
            cursor: pointer;
            position: relative;
            margin-bottom: 15px;
        }

        .drop-zone-container.drag-over {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        .upload-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-upload {
            background-color: #e8f0fe;
            color: #1967d2;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-upload:hover {
            background-color: #d2e3fc;
        }

        .drag-hint {
            display: block;
            margin-top: 10px;
            font-size: 13px;
            color: #9ca3af;
        }

        /* --- AI MODAL STYLES --- */
        #ai-modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .ai-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- AI Generátor Modal -->
    <div id="ai-modal" class="fixed inset-0 hidden flex items-center justify-center">
        <div class="ai-content bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800"><i class="fas fa-magic text-purple-600 mr-2"></i>AI Asistent pro nemovitosti</h3>
                <button id="close-ai-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Vložte sem hrubý text, poznámky nebo zkopírovaný popis (např. "Byt 3+kk, 90m2, bazén, výhled na moře, Alicante, cena 250000"). AI automaticky vyplní formulář a vytvoří popisky.</p>
            <textarea id="ai-input-text" class="w-full h-40 p-4 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-4 font-mono text-sm" placeholder="Zde vložte text..."></textarea>
            <div class="flex justify-end gap-3">
                <button id="btn-ai-fill" class="btn btn-ai w-full sm:w-auto">
                    <i class="fas fa-robot mr-2"></i>Zpracovat a vyplnit
                </button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Přihlášení</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-gray-700 font-bold mb-2">Email</label>
                    <input type="email" id="admin-username" class="input-field" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-gray-700 font-bold mb-2">Heslo</label>
                    <input type="password" id="admin-password" class="input-field" required>
                </div>
                <div id="admin-login-error" class="text-red-500 text-center mb-4 hidden"></div>
                <button type="submit" class="btn btn-primary w-full">Přihlásit se</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="md:hidden flex justify-between items-center bg-gray-800 text-white p-4">
                <h1 class="text-xl font-bold">HORIZON ESTATES</h1>
                <button id="mobile-menu-button" class="focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>

            <div id="sidebar" class="w-64 bg-gray-800 text-white p-5 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
                <h1 class="text-2xl font-bold mb-10 text-center hidden md:block">HORIZON ESTATES</h1>
                <nav class="flex-grow">
                    <a href="#" id="show-properties-btn" class="sidebar-link active"><i class="fas fa-list mr-2"></i>Správa nemovitostí</a></br>
                    <a href="#" id="show-tags-btn" class="sidebar-link"><i class="fas fa-tags mr-2"></i>Správa SEO tagů</a></br>
                    <a href="#" id="show-settings-btn" class="sidebar-link"><i class="fas fa-cog mr-2"></i>Nastavení</a></br>
                    <a href="#" id="show-pages-btn" class="sidebar-link"><i class="fas fa-file-alt mr-2"></i>Správa stránek</a>
                </nav>
                <button id="admin-logout-btn" class="btn btn-danger w-full mt-auto"><i class="fas fa-sign-out-alt mr-2"></i>Odhlásit se</button>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
                    <div id="firestore-error" class="error-message hidden mb-6"></div>

                    <!-- Notifikace o stahování -->
                    <div id="download-notification" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50">
                        <div class="flex items-center">
                            <i class="fas fa-spinner fa-spin mr-3"></i>
                            <div>
                                <h4 class="font-bold">Zpracovávám obrázky...</h4>
                                <p class="text-sm">Aplikuji vodoznak HORIZON-ESTATES.</p>
                            </div>
                        </div>
                    </div>

                    <div id="property-list-view">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa nemovitostí</h2>
                            <button id="add-property-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat nemovitost</button>
                        </header>

                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex -mb-px" id="property-country-tabs">
                                <button type="button" data-country="bulharsko" class="tab-button active" style="padding: 10px;">Bulharsko</button>
                                <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                            </nav>
                        </div>
                        
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Č. nabídky</th>
                                        <th class="table-header">Foto</th>
                                        <th class="table-header">Název (CZ)</th>
                                        <th class="table-header">Cena</th>
                                        <th class="table-header">Datum vydání</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="properties-table-body" style="text-align: center;">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="property-form-view" class="hidden">
                        <!-- HLAVIČKA S AI TLAČÍTKEM -->
                        <div class="flex justify-between items-center mb-6">
                            <h2 id="form-title" class="text-3xl font-semibold text-gray-700">Přidat novou nemovitost</h2>
                            <button type="button" id="open-ai-modal-btn" class="btn btn-ai">
                                <i class="fas fa-magic mr-2"></i>✨ AI Generátor
                            </button>
                        </div>

                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="property-form">
                                <input type="hidden" id="property-id">
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="property-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding: 5px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding: 5px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button" style="padding: 5px;">Němčina</button>
                                    </nav>
                                </div>

                                <div id="property-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="property-title-cz" class="block text-gray-700 font-bold mb-2">Název nemovitosti (CZ)</label>
                                        <input type="text" id="property-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-description-cz" class="block text-gray-700 font-bold mb-2">Popis (CZ)</label>
                                        <textarea id="property-description-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="property-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-en" class="block text-gray-700 font-bold mb-2">Název nemovitosti (EN)</label>
                                        <input type="text" id="property-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-en" class="block text-gray-700 font-bold mb-2">Popis (EN)</label>
                                        <textarea id="property-description-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="property-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-de" class="block text-gray-700 font-bold mb-2">Název nemovitosti (DE)</label>
                                        <input type="text" id="property-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-de" class="block text-gray-700 font-bold mb-2">Popis (DE)</label>
                                        <textarea id="property-description-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>

                                <hr class="my-6">

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label for="property-price" class="block text-gray-700 font-bold mb-2">Cena (€)</label>
                                        <input type="number" id="property-price" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-id" class="block text-gray-700 font-bold mb-2">Číslo nabídky</label>
                                        <input type="number" id="property-offer-id" class="input-field" placeholder="Zadejte číslo" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-type" class="block text-gray-700 font-bold mb-2">Typ nabídky</label>
                                        <select id="property-offer-type" class="input-field" required>
                                            <option value="prodej">Prodej</option>
                                            <option value="pronajem">Pronájem</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-country" class="block text-gray-700 font-bold mb-2">Země</label>
                                        <select id="property-country" class="input-field" required>
                                            <option value="">-- Vyberte zemi --</option>
                                            <option value="bulharsko">Bulharsko</option>
                                            <option value="spanelsko">Španělsko</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-location" class="block text-gray-700 font-bold mb-2">Lokalita</label>
                                        <select id="property-location" class="input-field" required></select>
                                    </div>
                                     <div>
                                        <label for="property-type" class="block text-gray-700 font-bold mb-2">Druh nemovitosti</label>
                                        <select id="property-type" class="input-field" required></select>
                                    </div>
                                    <div>
                                        <label for="property-rooms" class="block text-gray-700 font-bold mb-2">Dispozice</label>
                                        <select id="property-rooms" class="input-field"></select>
                                    </div>
                                     <div>
                                        <label for="property-floor" class="block text-gray-700 font-bold mb-2">Podlaží</label>
                                        <input type="number" id="property-floor" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-area" class="block text-gray-700 font-bold mb-2">Plocha (m²)</label>
                                        <input type="number" id="property-area" class="input-field">
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="property-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="property-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Další Vlastnosti</h3>
                                    <p class="text-sm text-gray-500 mb-4">Pořadí vlastností lze změnit v sekci "Nastavení".</p>
                                    <div id="features-container" class="feature-grid pt-4"></div>
                                </div>
                                
                                <!-- DRAG AND DROP SEKCE -->
                                <div class="mt-6">
                                    <label class="block text-gray-700 font-bold mb-2">Fotografie</label>
                                    
                                    <div id="drop-zone" class="drop-zone-container">
                                        <div class="upload-controls">
                                            <button type="button" class="btn-upload" id="btn-browse-images">Zvolit soubory</button>
                                            <div id="drop-status-text" class="text-gray-500 text-sm">Soubor nevybrán</div>
                                        </div>
                                        <span class="drag-hint">Tip: Soubory můžete do tohoto rámečku přímo přetáhnout myší.</span>
                                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
                                    </div>

                                    <div id="image-preview-container" class="image-preview-container"></div>
                                    
                                    <div id="upload-progress" class="hidden mt-4">
                                        <p id="upload-status" class="font-semibold">Nahrávám obrázky...</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit nemovitost</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="page-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa stránek</h2>
                            <button id="add-page-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat stránku</button>
                        </header>
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Název stránky (CZ)</th>
                                        <th class="table-header">URL (slug)</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="pages-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="page-form-view" class="hidden">
                        <h2 id="page-form-title" class="text-3xl font-semibold text-gray-700 mb-6">Přidat novou stránku</h2>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="page-form">
                                <input type="hidden" id="page-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="page-slug" class="block text-gray-700 font-bold mb-2">URL Slug (bez diakritiky, např. 'o-nas')</label>
                                        <input type="text" id="page-slug" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="page-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="page-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding-right: 8px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding-right: 8px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button">Němčina</button>
                                    </nav>
                                </div>
                                <div id="page-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="page-title-cz" class="block text-gray-700 font-bold mb-2">Název stránky (CZ)</label>
                                        <input type="text" id="page-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-content-cz" class="block text-gray-700 font-bold mb-2">Obsah stránky (CZ)</label>
                                        <textarea id="page-content-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-en" class="block text-gray-700 font-bold mb-2">Název stránky (EN)</label>
                                        <input type="text" id="page-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-en" class="block text-gray-700 font-bold mb-2">Obsah stránky (EN)</label>
                                        <textarea id="page-content-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-de" class="block text-gray-700 font-bold mb-2">Název stránky (DE)</label>
                                        <input type="text" id="page-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-de" class="block text-gray-700 font-bold mb-2">Obsah stránky (DE)</label>
                                        <textarea id="page-content-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-page-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit stránku</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tag-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa SEO tagů</h2>
                        </header>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Seznam tagů</h3>
                            <div id="tags-list" class="mb-4"></div>
                            <form id="form-tags" class="flex gap-2 items-start">
                                <div class="flex-grow">
                                    <input type="text" id="new-tag-input" placeholder="Přidat nebo upravit tag" class="input-field">
                                </div>
                                <button id="add-tag-btn" type="submit" class="btn btn-primary whitespace-nowrap">Přidat</button>
                                <button id="cancel-edit-tag-btn" type="button" class="btn btn-secondary whitespace-nowrap hidden">Zrušit</button>
                            </form>
                            <p class="text-sm text-gray-500 mt-4">Tyto tagy se automaticky přidají jako klíčová slova do hlavičky všech stránek pro zlepšení SEO.</p>
                        </div>
                    </div>

                    <div id="settings-view" class="hidden">
                         <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700 mb-6">Nastavení</h2>
                         
                         <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                              <h3 class="text-xl font-bold mb-4">Globální nastavení</h3>
                              <form id="global-settings-form">
                                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 1</h4>
                                            <label for="setting-contact1-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                            <input type="text" id="setting-contact1-name" class="input-field mb-4">
                                            <label for="setting-contact1-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                            <input type="text" id="setting-contact1-phone" class="input-field mb-4">
                                            <label for="setting-contact1-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                            <input type="text" id="setting-contact1-phone2" class="input-field mb-4">
                                            <label for="setting-contact1-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                            <input type="text" id="setting-contact1-email" class="input-field">
                                        </div>
                                         <div>
                                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 2</h4>
                                            <label for="setting-contact2-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                            <input type="text" id="setting-contact2-name" class="input-field mb-4">
                                            <label for="setting-contact2-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                            <input type="text" id="setting-contact2-phone" class="input-field mb-4">
                                            <label for="setting-contact2-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                            <input type="text" id="setting-contact2-phone2" class="input-field mb-4">
                                            <label for="setting-contact2-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                            <input type="text" id="setting-contact2-email" class="input-field">
                                        </div>
                                   </div>
                                <div class="mt-6 flex justify-end">
                                    <button type="submit" class="btn btn-primary">Uložit globální kontakty</button>
                                </div>
                              </form>
                              <hr class="my-6">
                              <h3 class="text-xl font-bold mb-4">Správa Vlastností (globální)</h3>
                              <p class="text-sm text-gray-500 mb-4">Zde můžete spravovat globální vlastnosti, které se nabízejí u všech nemovitostí. Pořadí zatím nelze měnit.</p>
                              <div id="features-list" class="mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                              <form id="form-features" class="space-y-4 p-4 border rounded-md">
                                   <h4 id="features-form-title" class="font-bold text-lg">Přidat novou vlastnost</h4>
                                   <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="new-features-cz-input" class="block text-sm font-medium text-gray-700">Název CZ</label>
                                            <input type="text" id="new-features-cz-input" class="input-field mt-1" required>
                                        </div>
                                        <div>
                                            <label for="new-features-en-input" class="block text-sm font-medium text-gray-700">Název EN</label>
                                            <input type="text" id="new-features-en-input" class="input-field mt-1">
                                        </div>
                                        <div>
                                            <label for="new-features-de-input" class="block text-sm font-medium text-gray-700">Název DE</label>
                                            <input type="text" id="new-features-de-input" class="input-field mt-1">
                                        </div>
                                   </div>
                                   <div class="flex gap-2 mt-4">
                                        <button type="submit" class="btn btn-primary w-full md:w-auto">Přidat</button>
                                        <button type="button" class="btn btn-secondary hidden cancel-edit-btn">Zrušit úpravu</button>
                                   </div>
                              </form>
                         </div>

                        <div class="mb-4 border-b border-gray-200">
                             <nav class="flex -mb-px" id="settings-tabs">
                                 <button type="button" data-country="bulharsko" class="tab-button active" style="padding-right: 15px;">Bulharsko</button>
                                 <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                             </nav>
                        </div>

                        <div id="country-specific-settings-container"></div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
            query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAi_ugQSDUjk4y8ne4zpAyTbzNrf96SWDc",
            authDomain: "login-40bf8.firebaseapp.com",
            projectId: "login-40bf8",
            storageBucket: "gs://login-40bf8.firebasestorage.app",
            messagingSenderId: "932200625165",
            appId: "1:932200625165:web:422564c4f9c3f9fbead144"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const initTinyMCE = (selector) => {
            tinymce.init({
                selector: selector,
                entity_encoding: 'raw',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
                height: 300,
            });
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            initTinyMCE('.tinymce-editor');
        });

        let filesToUpload = [];
        let existingImageUrls = [];
        let currentSettingsCountry = 'bulharsko';
        let currentPropertyListCountry = 'bulharsko';
        let currentEditItem = { type: null, key: null };
        let currentEditTag = null;

        // AI MODAL LOGIC
        const aiModal = document.getElementById('ai-modal');
        const btnOpenAi = document.getElementById('open-ai-modal-btn');
        const btnCloseAi = document.getElementById('close-ai-modal');
        const btnAiFill = document.getElementById('btn-ai-fill');
        const aiInput = document.getElementById('ai-input-text');

        btnOpenAi.addEventListener('click', () => {
            aiModal.classList.remove('hidden');
            aiModal.classList.add('flex');
        });

        btnCloseAi.addEventListener('click', () => {
            aiModal.classList.add('hidden');
            aiModal.classList.remove('flex');
        });

        // INTELIGENTNÍ PARSER A GENERÁTOR
        btnAiFill.addEventListener('click', async () => {
            const text = aiInput.value;
            if (!text.trim()) {
                alert("Prosím vložte text.");
                return;
            }

            // 1. Extrakce dat pomocí Regex
            const priceMatch = text.match(/(\d{1,3}[.,]?\d{0,3}[.,]?\d{0,3})\s*€|Cena:?\s*(\d+[.,]?\d+)/i);
            const areaMatch = text.match(/(\d+)\s*m²|plocha:?\s*(\d+)/i);
            const roomsMatch = text.match(/(\d+\s*\+\s*kk|\d+\s*\+\s*1)/i);
            const locationMatch = text.match(/Lokalita:?\s*([^,\n]+)/i) || text.match(/Location:?\s*([^,\n]+)/i);
            
            const featuresMap = {
                'bazén': 'bazen', 'pool': 'bazen',
                'terasa': 'terasa', 'terrace': 'terasa',
                'klimatizace': 'klimatizace', 'air': 'klimatizace',
                'výhled': 'vyhled-na-more', 'view': 'vyhled-na-more',
                'blízko moře': 'blizko-more', 'sea': 'blizko-more',
                'garáž': 's-garazi', 'garage': 's-garazi',
                'výtah': 's-vytahem', 'lift': 's-vytahem',
                'zařízený': 'zarizeny', 'furnished': 'zarizeny'
            };

            // 2. Vyplnění formuláře
            if (priceMatch) document.getElementById('property-price').value = priceMatch[1].replace(/[.,]/g, '') || priceMatch[2].replace(/[.,]/g, '');
            if (areaMatch) document.getElementById('property-area').value = areaMatch[1] || areaMatch[2];
            
            const setSelectByText = (id, searchText) => {
                const select = document.getElementById(id);
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].text.toLowerCase().includes(searchText.toLowerCase())) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            };

            if (roomsMatch) setSelectByText('property-rooms', roomsMatch[1]);
            if (locationMatch) setSelectByText('property-location', locationMatch[1].trim());

            // 3. Zaškrtnutí vlastností
            const checkboxes = document.querySelectorAll('#features-container input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            const lowerText = text.toLowerCase();
            for (const [keyword, featureIdStub] of Object.entries(featuresMap)) {
                if (lowerText.includes(keyword)) {
                    const foundCheckbox = Array.from(checkboxes).find(cb => 
                        cb.nextElementSibling.textContent.toLowerCase().includes(keyword) || 
                        cb.value.includes(featureIdStub)
                    );
                    if (foundCheckbox) foundCheckbox.checked = true;
                }
            }

            // 4. Generování Popisů (CZ, EN, DE)
            const type = document.getElementById('property-type').options[document.getElementById('property-type').selectedIndex]?.text || "Nemovitost";
            const disp = roomsMatch ? roomsMatch[1] : "prostorná";
            const loc = locationMatch ? locationMatch[1] : "skvělé lokalitě";
            const area = areaMatch ? `${areaMatch[1] || areaMatch[2]} m²` : "";

            const descCZ = `<p>Nabízíme k prodeji <strong>${type} ${disp}</strong> ${area ? `o velikosti ${area}` : ''} v lokalitě <strong>${loc}</strong>.</p>
            <p>Tato nemovitost je ideální volbou pro ty, kteří hledají komfort a styl. ${lowerText.includes('bazén') ? 'Součástí je krásný bazén.' : ''} ${lowerText.includes('moře') ? 'Nachází se jen kousek od moře.' : ''}</p>
            <p>Komplex nabízí veškeré vybavení pro pohodlný život či rekreaci.</p>`;

            const descEN = `<p>We offer for sale a <strong>${type} ${disp}</strong> ${area ? `with an area of ${area}` : ''} located in <strong>${loc}</strong>.</p>
            <p>This property is an ideal choice for those seeking comfort and style. ${lowerText.includes('bazén') ? 'Features a beautiful swimming pool.' : ''} ${lowerText.includes('moře') ? 'Located just a short distance from the sea.' : ''}</p>
            <p>The complex offers all amenities for comfortable living or holidays.</p>`;

            const descDE = `<p>Wir bieten zum Verkauf eine <strong>${type} ${disp}</strong> ${area ? `mit einer Fläche von ${area}` : ''} in <strong>${loc}</strong>.</p>
            <p>Diese Immobilie ist eine ideale Wahl für diejenigen, die Komfort und Stil suchen. ${lowerText.includes('bazén') ? 'Verfügt über einen schönen Swimmingpool.' : ''} ${lowerText.includes('moře') ? 'Nur einen kurzen Spaziergang vom Meer entfernt.' : ''}</p>
            <p>Der Komplex bietet alle Annehmlichkeiten für ein komfortables Leben oder Urlaub.</p>`;

            tinymce.get('property-description-cz').setContent(descCZ);
            tinymce.get('property-description-en').setContent(descEN);
            tinymce.get('property-description-de').setContent(descDE);

            document.getElementById('property-title-cz').value = `Prodej ${type} ${disp}, ${loc}`;
            document.getElementById('property-title-en').value = `For Sale ${type} ${disp}, ${loc}`;
            document.getElementById('property-title-de').value = `Zu Verkaufen ${type} ${disp}, ${loc}`;

            aiModal.classList.add('hidden');
            aiModal.classList.remove('flex');
            alert("Data byla úspěšně zpracována a formulář vyplněn!");
        });

        // --- PŮVODNÍ LOGIKA ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        
        const allViews = {
            propertyList: document.getElementById('property-list-view'),
            propertyForm: document.getElementById('property-form-view'),
            pageManagement: document.getElementById('page-management-view'),
            pageForm: document.getElementById('page-form-view'),
            tagManagement: document.getElementById('tag-management-view'),
            settings: document.getElementById('settings-view')
        };

        const sidebarButtons = {
            properties: document.getElementById('show-properties-btn'),
            pages: document.getElementById('show-pages-btn'),
            tags: document.getElementById('show-tags-btn'),
            settings: document.getElementById('show-settings-btn')
        };
        
        mobileMenuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        function slugify(text) {
            if (typeof text !== 'string') return '';
            const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
            const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
            const p = new RegExp(a.split('').join('|'), 'g')
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-') 
                .replace(p, c => b.charAt(a.indexOf(c))) 
                .replace(/&/g, '-and-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, '') 
        }
        
        function handleFirestoreError(error, context = "Neznámá operace") {
            console.error(`Firestore Error during ${context}:`, error);
            const firestoreError = document.getElementById('firestore-error');
            firestoreError.innerHTML = `<strong>Chyba databáze (${context}):</strong> ${error.message}. Zkontrolujte konzoli pro více detailů.`;
            firestoreError.classList.remove('hidden');
        }

        async function loadProperties(country) {
            try {
                const propertiesRef = collection(db, 'properties');
                const q = query(propertiesRef, where('country', '==', country));
                const querySnapshot = await getDocs(q);
                let properties = [];
                querySnapshot.forEach(doc => {
                    properties.push({ id: doc.id, ...doc.data() });
                });
                properties.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                const propertiesTableBody = document.getElementById('properties-table-body');
                propertiesTableBody.innerHTML = '';
                if (properties.length === 0) {
                    propertiesTableBody.innerHTML = '<tr><td colspan="7" class="table-cell text-center">Nebyly nalezeny žádné nemovitosti.</td></tr>';
                    return;
                }
                properties.forEach(prop => {
                    const firstImage = prop.images && prop.images.length > 0 ? prop.images[0] : 'https://placehold.co/100x60/eee/ccc?text=Foto';
                    const createdAt = prop.createdAt ? prop.createdAt.toDate().toLocaleDateString('cs-CZ') : 'N/A';
                    const statusClass = prop.status === 'Aktivní' ? 'active' : 'inactive';
                    
                    const row = `
                        <tr id="${prop.id}">
                            <td class="table-cell font-mono">${prop.offerId || 'N/A'}</td>
                            <td class="table-cell"><img src="${firstImage}" alt="Foto nemovitosti" class="w-24 h-16 object-cover rounded mx-auto"></td>
                            <td class="table-cell">
                                <p class="text-gray-900 whitespace-no-wrap font-bold">${prop.title_cz || prop.title}</p>
                                <p class="text-gray-600 whitespace-no-wrap">${prop.location}, ${prop.country}</p>
                            </td>
                            <td class="table-cell text-red-600 font-bold">€${Number(prop.price).toLocaleString('de-DE')}</td>
                            <td class="table-cell">${createdAt}</td>
                            <td class="table-cell">
                                <span class="status-toggle ${statusClass}" data-id="${prop.id}">${prop.status || 'Neaktivní'}</span>
                            </td>
                            <td class="table-cell">
                                <div class="flex justify-center space-x-2">
                                    <button class="download-property-btn text-green-600 hover:text-green-800" title="Stáhnout fotky s vodoznakem" data-id="${prop.id}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="edit-property-btn text-blue-600 hover:text-blue-900" data-id="${prop.id}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-property-btn text-red-600 hover:text-red-900" data-id="${prop.id}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    propertiesTableBody.innerHTML += row;
                });
            } catch (error) {
                handleFirestoreError(error, 'Načítání nemovitostí');
            }
        }

        // --- WATERMARK LOGIC ---
        function applyWatermarkToCanvas(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;

            // 1. Kreslíme původní obrázek
            ctx.drawImage(img, 0, 0);

            // 2. Nastavení textu vodoznaku
            const text = "HORIZON-ESTATES";
            const fontSize = canvas.width * 0.08; 
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // 3. Stín
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowBlur = fontSize / 5;
            ctx.shadowOffsetX = fontSize / 20;
            ctx.shadowOffsetY = fontSize / 20;

            // 4. Barva textu (BÍLÁ POLOPRŮHLEDNÁ)
            ctx.fillStyle = "rgba(255, 255, 255, 0.75)"; 
            
            // 5. Vykreslení textu PŘESNĚ DOPROSTŘED
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            return canvas;
        }

        async function downloadPropertyImagesWithWatermark(propertyId) {
            const notification = document.getElementById('download-notification');
            try {
                notification.classList.remove('hidden');
                const docRef = doc(db, 'properties', propertyId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Nemovitost nenalezena");
                const data = docSnap.data();
                const images = data.images || [];
                const offerId = data.offerId || propertyId;
                if (images.length === 0) { alert("Tato nemovitost nemá žádné fotografie."); return; }
                const zip = new JSZip();
                const folder = zip.folder(`nabidka_${offerId}`);
                const imagePromises = images.map(async (url, index) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; 
                        img.onload = () => {
                            try {
                                const canvas = applyWatermarkToCanvas(img);
                                canvas.toBlob((blob) => { if (blob) { folder.file(`image_${index + 1}.jpg`, blob); resolve(); } else { reject("Chyba"); } }, 'image/jpeg', 0.9);
                            } catch (err) { resolve(); }
                        };
                        img.onerror = () => resolve();
                        img.src = url;
                    });
                });
                await Promise.all(imagePromises);
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `Horizon_Estates_${offerId}.zip`);
            } catch (error) { alert("Chyba při stahování."); } finally { notification.classList.add('hidden'); }
        }

        document.getElementById('properties-table-body').addEventListener('click', async (e) => {
            const button = e.target.closest('button, span');
            if (!button) return;
            const id = button.dataset.id;
            if (button.classList.contains('download-property-btn')) { e.preventDefault(); await downloadPropertyImagesWithWatermark(id); return; }
            if (button.classList.contains('status-toggle')) {
                const currentStatus = button.textContent;
                const newStatus = currentStatus === 'Aktivní' ? 'Neaktivní' : 'Aktivní';
                try { await updateDoc(doc(db, 'properties', id), { status: newStatus }); loadProperties(currentPropertyListCountry); } catch (e) { handleFirestoreError(e, 'Změna stavu nemovitosti'); }
            }
            if (button.classList.contains('delete-property-btn')) {
                if (confirm('Opravdu chcete smazat tuto nemovitost?')) {
                     try {
                        const ref = doc(db, 'properties', id);
                        const d = await getDoc(ref);
                        if(d.exists()) {
                            const pData = d.data();
                            if(pData.images && pData.images.length > 0) {
                                const delProms = pData.images.map(u => deleteObject(ref(storage, u)).catch(() => {}));
                                await Promise.all(delProms);
                            }
                        }
                        await deleteDoc(ref);
                        document.getElementById(id).remove();
                    } catch (e) { handleFirestoreError(e, 'Mazání nemovitosti'); }
                }
            }
            if (button.classList.contains('edit-property-btn')) {
                try {
                    const d = await getDoc(doc(db, 'properties', id));
                    if (d.exists()) {
                        const p = d.data();
                        resetPropertyForm();
                        document.getElementById('property-id').value = d.id;
                        document.getElementById('form-title').textContent = 'Upravit nemovitost';
                        document.getElementById('property-title-cz').value = p.title_cz || '';
                        document.getElementById('property-title-en').value = p.title_en || '';
                        document.getElementById('property-title-de').value = p.title_de || '';
                        setEditorContent('property-description-cz', p.description_cz || '');
                        setEditorContent('property-description-en', p.description_en || '');
                        setEditorContent('property-description-de', p.description_de || '');
                        document.getElementById('property-price').value = p.price;
                        document.getElementById('property-offer-id').value = p.offerId;
                        document.getElementById('property-offer-type').value = p.offerType || 'prodej';
                        document.getElementById('property-country').value = p.country;
                        document.getElementById('property-floor').value = p.floor;
                        document.getElementById('property-area').value = p.area;
                        document.getElementById('property-status').value = p.status || 'Aktivní';
                        existingImageUrls = p.images || [];
                        await populateFormDropdowns(p.country, p);
                        await populateFeatures(p.features || []);
                        showView('propertyForm', 'properties');
                        previewImages();
                    }
                } catch (e) { handleFirestoreError(e, 'Editace nemovitosti'); }
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            adminLoginError.classList.add('hidden');
            try {
                const uc = await signInWithEmailAndPassword(auth, email, password);
                const uSnap = await getDoc(doc(db, 'users', uc.user.uid));
                if (uSnap.exists() && uSnap.data().role === 'admin') {
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    showView('propertyList', 'properties');
                    loadProperties(currentPropertyListCountry);
                } else {
                    adminLoginError.textContent = "Přístup odepřen.";
                    adminLoginError.classList.remove('hidden');
                    await signOut(auth);
                }
            } catch (e) {
                adminLoginError.textContent = "Nesprávný email nebo heslo.";
                adminLoginError.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', () => signOut(auth));

        sidebarButtons.properties.addEventListener('click', () => { showView('propertyList', 'properties'); loadProperties(currentPropertyListCountry); });
        sidebarButtons.pages.addEventListener('click', () => { showView('pageManagement', 'pages'); loadPages(); });
        sidebarButtons.tags.addEventListener('click', () => { showView('tagManagement', 'tags'); loadTags(); });
        sidebarButtons.settings.addEventListener('click', () => { showView('settings', 'settings'); loadGlobalSettings(); loadAndRenderCountrySettings(); });

        const propertyCountryTabs = document.getElementById('property-country-tabs');
        propertyCountryTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPropertyListCountry = e.target.dataset.country;
                propertyCountryTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadProperties(currentPropertyListCountry);
            }
        });

        const propertyForm = document.getElementById('property-form');
        
        function resetPropertyForm() {
            propertyForm.reset();
            document.getElementById('property-id').value = '';
            document.getElementById('form-title').textContent = 'Přidat novou nemovitost';
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('property-offer-id').readOnly = false;
            ['cz', 'en', 'de'].forEach(l => setEditorContent(`property-description-${l}`, ''));
            filesToUpload = []; existingImageUrls = [];
            document.getElementById('upload-progress').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('drop-status-text').textContent = "Soubor nevybrán";
        }

        async function openNewPropertyForm() {
            resetPropertyForm();
            await populateFormDropdowns('bulharsko');
            await populateFeatures([]);
            showView('propertyForm', 'properties');
        }

        document.getElementById('add-property-btn').addEventListener('click', openNewPropertyForm);
        document.getElementById('cancel-form-btn').addEventListener('click', () => showView('propertyList', 'properties'));
        document.getElementById('property-country').addEventListener('change', async (e) => await populateFormDropdowns(e.target.value));

        propertyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Ukládám...';
            try {
                const newUrls = await uploadImages(filesToUpload);
                const allUrls = [...existingImageUrls, ...newUrls];
                const feats = Array.from(document.querySelectorAll('#features-container input:checked')).map(cb => cb.value);
                const data = {
                    title_cz: document.getElementById('property-title-cz').value,
                    description_cz: getEditorContent('property-description-cz'),
                    title_en: document.getElementById('property-title-en').value,
                    description_en: getEditorContent('property-description-en'),
                    title_de: document.getElementById('property-title-de').value,
                    description_de: getEditorContent('property-description-de'),
                    price: Number(document.getElementById('property-price').value),
                    offerId: Number(document.getElementById('property-offer-id').value),
                    offerType: document.getElementById('property-offer-type').value,
                    country: document.getElementById('property-country').value,
                    location: document.getElementById('property-location').value,
                    type: document.getElementById('property-type').value,
                    rooms: document.getElementById('property-rooms').value,
                    floor: Number(document.getElementById('property-floor').value) || null,
                    area: Number(document.getElementById('property-area').value) || null,
                    images: allUrls, features: feats,
                    status: document.getElementById('property-status').value,
                    lastUpdated: serverTimestamp()
                };
                const id = document.getElementById('property-id').value;
                if (id) await updateDoc(doc(db, 'properties', id), data);
                else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'properties'), data); }
                showView('propertyList', 'properties'); loadProperties(currentPropertyListCountry);
            } catch (e) { handleFirestoreError(e, 'Ukládání nemovitosti'); } finally { btn.disabled = false; btn.textContent = 'Uložit nemovitost'; }
        });

        // Image logic
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('image-upload');
        const browseBtn = document.getElementById('btn-browse-images');
        
        browseBtn.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('click', (e) => { if (e.target !== browseBtn) fileInput.click(); });
        fileInput.addEventListener('change', (e) => { filesToUpload.push(...e.target.files); updateStatusText(); previewImages(); fileInput.value = ''; });
        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('drag-over'); }));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.remove('drag-over'); }));
        dropZone.addEventListener('drop', (e) => { if(e.dataTransfer.files.length){ filesToUpload.push(...e.dataTransfer.files); updateStatusText(); previewImages(); }});

        function updateStatusText() { document.getElementById('drop-status-text').textContent = filesToUpload.length > 0 ? `Připraveno: ${filesToUpload.length} fotek` : "Soubor nevybrán"; }
        function previewImages() {
            const c = document.getElementById('image-preview-container'); c.innerHTML = '';
            [...existingImageUrls.map((u, i) => ({t:'existing', d:u, i})), ...filesToUpload.map((f, i) => ({t:'new', d:f, i}))].forEach(img => {
                const div = document.createElement('div'); div.className = 'image-preview-item';
                div.innerHTML = `<img src="${img.t==='existing'?img.d:URL.createObjectURL(img.d)}"><button type="button" class="remove-image-btn" data-type="${img.t}" data-index="${img.i}">&times;</button>`;
                c.appendChild(div);
            });
        }
        document.getElementById('image-preview-container').addEventListener('click', (e) => {
            if(e.target.classList.contains('remove-image-btn')) {
                const {type, index} = e.target.dataset;
                if(type==='new') filesToUpload.splice(index, 1); else existingImageUrls.splice(index, 1);
                updateStatusText(); previewImages();
            }
        });

        async function uploadImages(files) {
            if(!files.length) return [];
            document.getElementById('upload-progress').classList.remove('hidden');
            const urls = [];
            for(let i=0; i<files.length; i++) {
                const refS = ref(storage, `properties/${Date.now()}-${files[i].name}`);
                await uploadBytes(refS, files[i]);
                urls.push(await getDownloadURL(refS));
                document.getElementById('progress-bar').style.width = `${((i+1)/files.length)*100}%`;
            }
            return urls;
        }

        function setEditorContent(id, c) { if(tinymce.get(id)) tinymce.get(id).setContent(c||''); }
        function getEditorContent(id) { return tinymce.get(id) ? tinymce.get(id).getContent() : ''; }

        async function populateFormDropdowns(c, p={}) {
            const sels = ['property-location', 'property-type', 'property-rooms'];
            sels.forEach(s => document.getElementById(s).innerHTML = '<option>Načítání...</option>');
            try {
                const d = await getDoc(doc(db, 'settings', c));
                if(!d.exists()) return;
                const set = d.data();
                const fill = (id, items, val) => {
                    const el = document.getElementById(id); el.innerHTML = '<option value="">-- Vyberte --</option>';
                    (items||[]).sort((a,b)=>(a.name_cz||a).localeCompare(b.name_cz||b, 'cs')).forEach(i => {
                        const v = i.name_cz || i;
                        el.add(new Option(v, v, false, v===val));
                    });
                };
                fill('property-location', set.locations, p.location);
                fill('property-type', set.types, p.type);
                fill('property-rooms', set.rooms, p.rooms);
            } catch(e){}
        }

        async function populateFeatures(sel=[]) {
            const c = document.getElementById('features-container'); c.innerHTML = '';
            try {
                const d = await getDoc(doc(db, 'settings', 'global'));
                (d.data().features||[]).sort((a,b)=>a.name_cz.localeCompare(b.name_cz,'cs')).forEach(f => {
                    c.innerHTML += `<div class="feature-item"><input type="checkbox" id="f-${f.key}" value="${f.key}" ${sel.includes(f.key)?'checked':''}><label for="f-${f.key}" class="ml-2">${f.name_cz}</label></div>`;
                });
            } catch(e){}
        }

        const ptb = document.getElementById('pages-table-body');
        const pageForm = document.getElementById('page-form');
        async function loadPages() {
            try {
                const q = query(collection(db, 'pages'), orderBy('title_cz'));
                const qs = await getDocs(q);
                ptb.innerHTML = '';
                qs.forEach(doc => {
                    const p = doc.data();
                    ptb.innerHTML += `<tr id="page-${doc.id}"><td class="table-cell font-bold">${p.title_cz}</td><td class="table-cell">/${p.slug}</td><td class="table-cell">${p.status}</td><td class="table-cell"><button class="edit-page-btn text-blue-600 mr-4" data-id="${doc.id}">Edit</button><button class="delete-page-btn text-red-600" data-id="${doc.id}">Del</button></td></tr>`;
                });
            } catch(e) { handleFirestoreError(e, 'Načítání stránek'); }
        }

        function resetPageForm() {
            pageForm.reset(); document.getElementById('page-id').value='';
            ['cz','en','de'].forEach(l => setEditorContent(`page-content-${l}`, ''));
            document.getElementById('page-form-title').textContent='Přidat novou stránku';
        }

        document.getElementById('add-page-btn').addEventListener('click', () => { resetPageForm(); showView('pageForm', 'pages'); });
        document.getElementById('cancel-page-form-btn').addEventListener('click', () => showView('pageManagement', 'pages'));
        document.getElementById('page-title-cz').addEventListener('input', (e) => { document.getElementById('page-slug').value = slugify(e.target.value); });

        pageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('page-id').value;
            const data = {
                slug: document.getElementById('page-slug').value, status: document.getElementById('page-status').value,
                title_cz: document.getElementById('page-title-cz').value, content_cz: getEditorContent('page-content-cz'),
                title_en: document.getElementById('page-title-en').value, content_en: getEditorContent('page-content-en'),
                title_de: document.getElementById('page-title-de').value, content_de: getEditorContent('page-content-de')
            };
            try {
                if (id) await updateDoc(doc(db, 'pages', id), data); else await addDoc(collection(db, 'pages'), data);
                showView('pageManagement', 'pages'); loadPages();
            } catch (e) { handleFirestoreError(e, 'Ukládání stránky'); }
        });

        ptb.addEventListener('click', async (e) => {
            const btn = e.target.closest('button'); if(!btn) return;
            const id = btn.dataset.id;
            if(btn.classList.contains('delete-page-btn') && confirm('Smazat?')) {
                try { await deleteDoc(doc(db, 'pages', id)); loadPages(); } catch(e) { handleFirestoreError(e, 'Mazání'); }
            }
            if(btn.classList.contains('edit-page-btn')) {
                try {
                    const d = await getDoc(doc(db, 'pages', id));
                    if(d.exists()) {
                        const p = d.data(); resetPageForm();
                        document.getElementById('page-id').value=id; document.getElementById('page-slug').value=p.slug;
                        document.getElementById('page-status').value=p.status;
                        ['cz','en','de'].forEach(l => {
                            document.getElementById(`page-title-${l}`).value=p[`title_${l}`]||'';
                            setEditorContent(`page-content-${l}`, p[`content_${l}`]||'');
                        });
                        document.getElementById('page-form-title').textContent='Upravit stránku';
                        showView('pageForm', 'pages');
                    }
                } catch(e) { handleFirestoreError(e, 'Editace'); }
            }
        });

        async function loadTags() {
            const c = document.getElementById('tags-list');
            try {
                const d = await getDoc(doc(db, 'settings', 'global'));
                c.innerHTML = (d.data()?.tags||[]).map(t=>`<div class="bg-gray-100 p-2 flex justify-between"><span>${t}</span><button class="delete-tag-btn text-red-500" data-tag="${t}">&times;</button></div>`).join('');
            } catch(e) {}
        }
        document.getElementById('tags-list').addEventListener('click', async(e)=>{ if(e.target.classList.contains('delete-tag-btn') && confirm('Smazat?')) { await updateDoc(doc(db,'settings','global'),{tags:arrayRemove(e.target.dataset.tag)}); loadTags(); }});
        document.getElementById('form-tags').addEventListener('submit', async(e)=>{ e.preventDefault(); const v=document.getElementById('new-tag-input').value.trim(); if(v) { await updateDoc(doc(db,'settings','global'),{tags:arrayUnion(v)}); loadTags(); }});

        function renderList(type, items, formId) {
            const c = document.getElementById(`${type}-list`); c.innerHTML = '';
            (items||[]).sort((a,b)=>(a.name_cz||a).localeCompare(b.name_cz||b, 'cs')).forEach(i => {
                const k = i.key || slugify(i); const n = i.name_cz || i;
                c.innerHTML += `<div class="bg-gray-100 p-2 flex justify-between"><span>${n}</span><div><button class="edit-setting-item-btn text-blue-600 mr-2" data-type="${type}" data-key="${k}" data-form-id="${formId}">Edit</button><button class="delete-setting-item-btn text-red-500" data-type="${type}" data-key="${k}">Del</button></div></div>`;
            });
        }

        function renderMenuItems(t, i) {
            const c = document.getElementById(`${t}-menu-list-${currentSettingsCountry}`); c.innerHTML='';
            (i||[]).forEach(m => c.innerHTML += `<div class="bg-gray-100 p-2 flex justify-between"><span>${m.title} -> /${m.slug}</span><button class="delete-menu-item-btn text-red-500" data-menu-type="${t}" data-title="${m.title}" data-slug="${m.slug}">Del</button></div>`);
        }

        function renderCountrySettingsHTML(c) {
            const cap = c.charAt(0).toUpperCase() + c.slice(1);
            let extra = '';
            if(c==='bulharsko') extra=`<div><h4>Menu "O Bulharsku"</h4><div id="bulgaria-menu-list-${c}"></div><div class="flex gap-2"><input id="new-bulgaria-menu-title-${c}" class="input-field"><select id="new-bulgaria-menu-link-${c}" class="input-field"></select><button data-menu-type="bulgaria" class="add-menu-item-btn btn btn-primary">Přidat</button></div></div>`;
            if(c==='spanelsko') extra=`<div><h4>Menu "O Španělsku"</h4><div id="spain-menu-list-${c}"></div><div class="flex gap-2"><input id="new-spain-menu-title-${c}" class="input-field"><select id="new-spain-menu-link-${c}" class="input-field"></select><button data-menu-type="spain" class="add-menu-item-btn btn btn-primary">Přidat</button></div></div>`;
            return `<div class="bg-white p-6 mb-8"><h3>Nastavení pro ${cap}</h3><form id="${c}-settings-form"><label>Text loga</label><input id="setting-logo-text-${c}" class="input-field"><button type="submit" class="btn btn-primary mt-4">Uložit</button></form></div>
            <div class="bg-white p-6 mb-8"><h3>Menu</h3><div class="grid grid-cols-3 gap-8"><div><h4>Info</h4><div id="info-menu-list-${c}"></div><div class="flex gap-2"><input id="new-info-menu-title-${c}" class="input-field"><select id="new-info-menu-link-${c}" class="input-field"></select><button data-menu-type="info" class="add-menu-item-btn btn btn-primary">Přidat</button></div></div>
            <div><h4>Služby</h4><div id="services-menu-list-${c}"></div><div class="flex gap-2"><input id="new-services-menu-title-${c}" class="input-field"><select id="new-services-menu-link-${c}" class="input-field"></select><button data-menu-type="services" class="add-menu-item-btn btn btn-primary">Přidat</button></div></div>${extra}</div></div>
            <div class="grid grid-cols-3 gap-8">${createSettingsForm('locations','Lokalita',0)}${createSettingsForm('types','Druh',1)}${createSettingsForm('rooms','Dispozice',1)}</div>`;
        }

        function createSettingsForm(t, tit, m) {
            const inps = m ? `<input id="new-${t}-cz-input" class="input-field" placeholder="CZ"><input id="new-${t}-en-input" class="input-field" placeholder="EN"><input id="new-${t}-de-input" class="input-field" placeholder="DE">` : `<input id="new-${t}-cz-input" class="input-field" placeholder="Název">`;
            return `<div class="bg-white p-6"><h3>${tit}</h3><div id="${t}-list"></div><form id="form-${t}"><h4>Přidat</h4><div class="grid gap-2">${inps}</div><div class="flex gap-2 mt-4"><button type="submit" class="btn btn-primary">Přidat</button><button type="button" class="btn btn-secondary hidden cancel-edit-btn">Zrušit</button></div></form></div>`;
        }

        async function loadAndRenderCountrySettings() {
            const c = currentSettingsCountry;
            const d = await getDoc(doc(db, 'settings', c));
            const s = d.exists() ? d.data() : {};
            document.getElementById('country-specific-settings-container').innerHTML = renderCountrySettingsHTML(c);
            document.getElementById(`setting-logo-text-${c}`).value = s.logoText || '';
            
            const pages = await getDocs(collection(db, 'pages'));
            const sels = [document.getElementById(`new-info-menu-link-${c}`), document.getElementById(`new-services-menu-link-${c}`), document.getElementById(`new-bulgaria-menu-link-${c}`), document.getElementById(`new-spain-menu-link-${c}`)].filter(Boolean);
            sels.forEach(sel => { sel.innerHTML='<option value="">Vyberte</option>'; pages.forEach(p => sel.add(new Option(p.data().title_cz, p.data().slug))); });

            renderMenuItems('info', s.infoMenu); renderMenuItems('services', s.servicesMenu);
            if(c==='bulharsko') renderMenuItems('bulgaria', s.bulgariaMenu);
            if(c==='spanelsko') renderMenuItems('spain', s.spainMenu);
            renderList('locations', s.locations, 'form-locations'); renderList('types', s.types, 'form-types'); renderList('rooms', s.rooms, 'form-rooms');
        }

        async function loadGlobalSettings() {
            const d = await getDoc(doc(db, 'settings', 'global'));
            if(d.exists()) {
                const s = d.data();
                ['contact1_name','contact1_phone','contact1_phone2','contact1_email','contact2_name','contact2_phone','contact2_phone2','contact2_email'].forEach(k => document.getElementById(`setting-${k.replace('_','-')}`).value = s[k]||'');
                renderList('features', s.features, 'form-features');
            }
        }

        document.getElementById('global-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const d = {}; ['contact1_name','contact1_phone','contact1_phone2','contact1_email','contact2_name','contact2_phone','contact2_phone2','contact2_email'].forEach(k => d[k] = document.getElementById(`setting-${k.replace('_','-')}`).value);
            await setDoc(doc(db,'settings','global'), d, {merge:true}); alert('Uloženo');
        });

        // Settings logic (generic)
        document.getElementById('settings-view').addEventListener('click', async (e) => {
            const btn = e.target.closest('button'); if(!btn) return;
            if(btn.classList.contains('delete-setting-item-btn') && confirm('Smazat?')) {
                const {type, key} = btn.dataset; const isG = type==='features';
                const ref = doc(db, 'settings', isG?'global':currentSettingsCountry);
                const d = await getDoc(ref); const arr = d.data()[type]||[];
                const it = arr.find(i => (i.key||slugify(i))===key);
                if(it) { await updateDoc(ref, {[type]: arrayRemove(it)}); isG ? loadGlobalSettings() : loadAndRenderCountrySettings(); }
            }
            if(btn.classList.contains('edit-setting-item-btn')) {
                e.preventDefault(); const {type, key, formId} = btn.dataset;
                const form = document.getElementById(formId);
                const isG = type==='features';
                const d = await getDoc(doc(db, 'settings', isG?'global':currentSettingsCountry));
                const it = (d.data()[type]||[]).find(i => (i.key||slugify(i))===key);
                if(it) {
                    currentEditItem = {type, key};
                    form.querySelector(`#new-${type}-cz-input`).value = it.name_cz || it;
                    if(form.querySelector(`#new-${type}-en-input`)) {
                        form.querySelector(`#new-${type}-en-input`).value = it.name_en||'';
                        form.querySelector(`#new-${type}-de-input`).value = it.name_de||'';
                    }
                    form.querySelector('.cancel-edit-btn').classList.remove('hidden');
                }
            }
            if(btn.classList.contains('cancel-edit-btn')) {
                const f = btn.closest('form'); f.reset(); currentEditItem={type:null,key:null}; btn.classList.add('hidden');
            }
            if(btn.classList.contains('add-menu-item-btn')) {
                e.preventDefault(); const t = btn.dataset.menuType;
                const tit = document.getElementById(`new-${t}-menu-title-${currentSettingsCountry}`).value;
                const sl = document.getElementById(`new-${t}-menu-link-${currentSettingsCountry}`).value;
                if(tit&&sl) { await setDoc(doc(db,'settings',currentSettingsCountry), {[t+'Menu']: arrayUnion({title:tit, slug:sl})}, {merge:true}); loadAndRenderCountrySettings(); }
            }
            if(btn.classList.contains('delete-menu-item-btn') && confirm('Smazat?')) {
                e.preventDefault(); const {menuType, title, slug} = btn.dataset;
                await updateDoc(doc(db,'settings',currentSettingsCountry), {[menuType+'Menu']: arrayRemove({title, slug})}); loadAndRenderCountrySettings();
            }
            if(btn.closest('form')?.id.endsWith('-settings-form')) {
                e.preventDefault(); 
                await setDoc(doc(db,'settings',currentSettingsCountry), {logoText: document.getElementById(`setting-logo-text-${currentSettingsCountry}`).value}, {merge:true}); alert('Uloženo');
            }
        });

        document.getElementById('settings-view').addEventListener('submit', async (e) => {
            if(e.target.id.startsWith('form-')) {
                e.preventDefault(); const f = e.target; const type = f.id.split('-')[1];
                const isG = type==='features'; const ref = doc(db, 'settings', isG?'global':currentSettingsCountry);
                const d = await getDoc(ref); let arr = d.data()?.[type]||[];
                const cz = f.querySelector(`#new-${type}-cz-input`).value; if(!cz) return;
                const key = currentEditItem.key || slugify(cz);
                const newItem = f.querySelector(`#new-${type}-en-input`) ? {key, name_cz:cz, name_en:f.querySelector(`#new-${type}-en-input`).value, name_de:f.querySelector(`#new-${type}-de-input`).value} : cz;
                
                if(currentEditItem.key) {
                    const idx = arr.findIndex(i => (i.key||slugify(i))===currentEditItem.key);
                    if(idx>-1) arr[idx] = newItem;
                } else arr.push(newItem);
                
                await setDoc(ref, {[type]: arr}, {merge:true});
                f.reset(); currentEditItem={type:null,key:null}; f.querySelector('.cancel-edit-btn').classList.add('hidden');
                isG ? loadGlobalSettings() : loadAndRenderCountrySettings();
            }
        });

        function setupTabSwitching(tabsId, contentClass) {
            const tabsContainer = document.getElementById(tabsId);
            if (!tabsContainer) return;
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const lang = e.target.dataset.lang;
                    tabsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll(`.${contentClass}`).forEach(content => {
                        if (content.id.includes(`-${lang}`)) content.classList.add('active'); else content.classList.remove('active');
                    });
                }
            });
        }
        setupTabSwitching('property-lang-tabs', 'lang-tab-content');
        setupTabSwitching('page-lang-tabs', 'lang-tab-content');

    </script>
</body>
</html>

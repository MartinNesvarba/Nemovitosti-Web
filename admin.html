<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Správa obsahu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Rich Text Editor TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/t62v88urbx396otieiqu7apcy81f9ulf00f3eb24ym4s0x2c/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* Custom Tailwind directives for cleaner HTML */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        @layer components {
            .btn { @apply font-bold py-2 px-4 rounded transition duration-200; }
            .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white disabled:bg-blue-400; }
            .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
            .btn-danger { @apply bg-red-500 hover:bg-red-700 text-white; }
            .table-header { @apply px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap; }
            .table-cell { @apply px-5 py-5 border-b border-gray-200 bg-white text-sm align-middle text-center; }
            .input-field { @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline; }
            .sidebar-link { @apply block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700; }
            .sidebar-link.active { @apply bg-gray-600 font-bold; }
            .tab-button { @apply px-4 py-2 font-semibold text-gray-600 rounded-t-lg transition-colors duration-200; }
            .tab-button.active { @apply bg-white text-blue-600 border-b-2 border-blue-600; }
            .status-toggle { @apply cursor-pointer font-bold py-1 px-3 rounded-full text-xs; }
            .status-toggle.active { @apply bg-green-100 text-green-800; }
            .status-toggle.inactive { @apply bg-red-100 text-red-800; }
            .drop-zone-active { @apply border-blue-500 bg-blue-50; }
        }
        
        /* Custom styles for UI elements */
        .hidden { display: none; }
        .error-message { color: #D8000C; background-color: #FFD2D2; border: 1px solid #D8000C; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        .image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 0.5rem; }
        .remove-image-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .feature-item { @apply flex items-center; }
        .feature-item input { @apply w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500; }
        .feature-item label { @apply ml-2 text-sm font-medium text-gray-900; }
        .lang-tab-content { display: none; }
        .lang-tab-content.active { display: block; }

        /* Styles for tag list layout */
        #tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* 12px */
        }

        /* Styles for SortableJS */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
        }
        .sortable-item {
            cursor: move; /* grab */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Přihlášení</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-gray-700 font-bold mb-2">Email</label>
                    <input type="email" id="admin-username" class="input-field" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-gray-700 font-bold mb-2">Heslo</label>
                    <input type="password" id="admin-password" class="input-field" required>
                </div>
                <div id="admin-login-error" class="text-red-500 text-center mb-4 hidden"></div>
                <button type="submit" class="btn btn-primary w-full">Přihlásit se</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard (hidden by default) -->
    <div id="dashboard" class="hidden">
        <div class="relative min-h-screen md:flex">
            <!-- Mobile menu button -->
            <div class="md:hidden flex justify-between items-center bg-gray-800 text-white p-4">
                <h1 class="text-xl font-bold">HORIZON ESTATES</h1>
                <button id="mobile-menu-button" class="focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>

            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 text-white p-5 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
                <h1 class="text-2xl font-bold mb-10 text-center hidden md:block">HORIZON ESTATES</h1>
                <nav class="flex-grow">
                    <a href="#" id="show-properties-btn" class="sidebar-link active"><i class="fas fa-list mr-2"></i>Správa nemovitostí</a></br>
                    <a href="#" id="show-tags-btn" class="sidebar-link"><i class="fas fa-tags mr-2"></i>Správa tagů</a></br>
                    <a href="#" id="show-settings-btn" class="sidebar-link"><i class="fas fa-cog mr-2"></i>Nastavení</a></br>
                    <a href="#" id="show-pages-btn" class="sidebar-link"><i class="fas fa-file-alt mr-2"></i>Správa stránek</a>
                </nav>
                <button id="admin-logout-btn" class="btn btn-danger w-full mt-auto"><i class="fas fa-sign-out-alt mr-2"></i>Odhlásit se</button>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
                    <div id="firestore-error" class="error-message hidden mb-6"></div>

                    <!-- Property List View -->
                    <div id="property-list-view">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa nemovitostí</h2>
                            <button id="add-property-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat nemovitost</button>
                        </header>

                        <!-- Country Tabs for Property List -->
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex -mb-px" id="property-country-tabs">
                                <button type="button" data-country="bulharsko" class="tab-button active" style="padding: 10px;">Bulharsko</button>
                                <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                            </nav>
                        </div>
                        
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Č. nabídky</th>
                                        <th class="table-header">Foto</th>
                                        <th class="table-header">Název (CZ)</th>
                                        <th class="table-header">Cena</th>
                                        <th class="table-header">Datum vydání</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="properties-table-body" style="text-align: center;">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Property Form View (hidden by default) -->
                    <div id="property-form-view" class="hidden">
                        <h2 id="form-title" class="text-3xl font-semibold text-gray-700 mb-6">Přidat novou nemovitost</h2>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="property-form">
                                <input type="hidden" id="property-id">
                                <!-- Language Tabs -->
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="property-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding: 5px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding: 5px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button" style="padding: 5px;">Němčina</button>
                                    </nav>
                                </div>

                                <!-- CZ Content -->
                                <div id="property-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="property-title-cz" class="block text-gray-700 font-bold mb-2">Název nemovitosti (CZ)</label>
                                        <input type="text" id="property-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-description-cz" class="block text-gray-700 font-bold mb-2">Popis (CZ)</label>
                                        <textarea id="property-description-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <!-- EN Content -->
                                <div id="property-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-en" class="block text-gray-700 font-bold mb-2">Název nemovitosti (EN)</label>
                                        <input type="text" id="property-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-en" class="block text-gray-700 font-bold mb-2">Popis (EN)</label>
                                        <textarea id="property-description-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <!-- DE Content -->
                                <div id="property-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-de" class="block text-gray-700 font-bold mb-2">Název nemovitosti (DE)</label>
                                        <input type="text" id="property-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-de" class="block text-gray-700 font-bold mb-2">Popis (DE)</label>
                                        <textarea id="property-description-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>

                                <hr class="my-6">

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label for="property-price" class="block text-gray-700 font-bold mb-2">Cena (€)</label>
                                        <input type="number" id="property-price" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-id" class="block text-gray-700 font-bold mb-2">Číslo nabídky</label>
                                        <input type="number" id="property-offer-id" class="input-field" placeholder="Zadejte číslo" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-type" class="block text-gray-700 font-bold mb-2">Typ nabídky</label>
                                        <select id="property-offer-type" class="input-field" required>
                                            <option value="prodej">Prodej</option>
                                            <option value="pronajem">Pronájem</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-country" class="block text-gray-700 font-bold mb-2">Země</label>
                                        <select id="property-country" class="input-field" required>
                                            <option value="">-- Vyberte zemi --</option>
                                            <option value="bulharsko">Bulharsko</option>
                                            <option value="spanelsko">Španělsko</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-location" class="block text-gray-700 font-bold mb-2">Lokalita</label>
                                        <select id="property-location" class="input-field" required></select>
                                    </div>
                                     <div>
                                        <label for="property-type" class="block text-gray-700 font-bold mb-2">Druh nemovitosti</label>
                                        <select id="property-type" class="input-field" required></select>
                                    </div>
                                    <div>
                                        <label for="property-rooms" class="block text-gray-700 font-bold mb-2">Dispozice</label>
                                        <select id="property-rooms" class="input-field"></select>
                                    </div>
                                     <div>
                                        <label for="property-floor" class="block text-gray-700 font-bold mb-2">Podlaží</label>
                                        <input type="number" id="property-floor" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-area" class="block text-gray-700 font-bold mb-2">Plocha (m²)</label>
                                        <input type="number" id="property-area" class="input-field">
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="property-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="property-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Další Vlastnosti</h3>
                                    <div id="features-container" class="feature-grid pt-4"></div>
                                </div>
                                <div class="mt-6">
                                    <label class="block text-gray-700 font-bold mb-2">Fotografie</label>
                                    <!-- NEW: Drag and Drop Zone -->
                                    <div id="image-drop-zone" class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-colors duration-200 hover:border-blue-500">
                                        <div class="flex flex-col items-center justify-center pointer-events-none">
                                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                            <p class="text-gray-500">Přetáhněte soubory sem nebo <span class="font-semibold text-blue-600">klikněte pro výběr</span></p>
                                            <p class="text-xs text-gray-400 mt-1">Podporované formáty: JPG, PNG, WEBP atd.</p>
                                        </div>
                                        <input type="file" id="image-upload" multiple accept="image/*" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                                    </div>
                                    <!-- END: Drag and Drop Zone -->
                                    <div id="image-preview-container" class="image-preview-container"></div>
                                    <div id="upload-progress" class="hidden mt-4">
                                        <p id="upload-status" class="font-semibold">Nahrávám obrázky...</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit nemovitost</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Page Management View -->
                    <div id="page-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa stránek</h2>
                            <button id="add-page-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat stránku</button>
                        </header>
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Název stránky (CZ)</th>
                                        <th class="table-header">URL (slug)</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="pages-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add/Edit Page Form View -->
                    <div id="page-form-view" class="hidden">
                        <h2 id="page-form-title" class="text-3xl font-semibold text-gray-700 mb-6">Přidat novou stránku</h2>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="page-form">
                                <input type="hidden" id="page-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="page-slug" class="block text-gray-700 font-bold mb-2">URL Slug (bez diakritiky, např. 'o-nas')</label>
                                        <input type="text" id="page-slug" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="page-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="page-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding-right: 8px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding-right: 8px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button">Němčina</button>
                                    </nav>
                                </div>
                                <div id="page-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="page-title-cz" class="block text-gray-700 font-bold mb-2">Název stránky (CZ)</label>
                                        <input type="text" id="page-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-content-cz" class="block text-gray-700 font-bold mb-2">Obsah stránky (CZ)</label>
                                        <textarea id="page-content-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-en" class="block text-gray-700 font-bold mb-2">Název stránky (EN)</label>
                                        <input type="text" id="page-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-en" class="block text-gray-700 font-bold mb-2">Obsah stránky (EN)</label>
                                        <textarea id="page-content-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-de" class="block text-gray-700 font-bold mb-2">Název stránky (DE)</label>
                                        <input type="text" id="page-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-de" class="block text-gray-700 font-bold mb-2">Obsah stránky (DE)</label>
                                        <textarea id="page-content-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-page-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit stránku</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Tag Management View -->
                    <div id="tag-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa SEO tagů</h2>
                        </header>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Seznam tagů</h3>
                            <div id="tags-list" class="mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-tag-input" placeholder="Přidat nový tag" class="input-field">
                                <button id="add-tag-btn" type="button" class="btn btn-primary whitespace-nowrap">Přidat</button>
                            </div>
                            <p class="text-sm text-gray-500 mt-4">Tyto tagy se automaticky přidají jako klíčová slova do hlavičky všech stránek pro zlepšení SEO.</p>
                        </div>
                    </div>

                    <!-- Settings View -->
                    <div id="settings-view" class="hidden">
                         <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700 mb-6">Nastavení</h2>
                         
                         <!-- Global Settings Section -->
                         <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                                <h3 class="text-xl font-bold mb-4">Globální nastavení</h3>
                                <form id="global-settings-form">
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                         <div>
                                             <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 1</h4>
                                             <label for="setting-contact1-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                             <input type="text" id="setting-contact1-name" class="input-field mb-4">
                                             <label for="setting-contact1-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                             <input type="text" id="setting-contact1-phone" class="input-field mb-4">
                                             <label for="setting-contact1-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                             <input type="text" id="setting-contact1-phone2" class="input-field mb-4">
                                             <label for="setting-contact1-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                             <input type="text" id="setting-contact1-email" class="input-field">
                                         </div>
                                          <div>
                                             <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 2</h4>
                                             <label for="setting-contact2-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                             <input type="text" id="setting-contact2-name" class="input-field mb-4">
                                             <label for="setting-contact2-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                             <input type="text" id="setting-contact2-phone" class="input-field mb-4">
                                             <label for="setting-contact2-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                             <input type="text" id="setting-contact2-phone2" class="input-field mb-4">
                                             <label for="setting-contact2-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                             <input type="text" id="setting-contact2-email" class="input-field">
                                         </div>
                                     </div>
                                <div class="mt-6 flex justify-end">
                                    <button type="submit" class="btn btn-primary">Uložit globální kontakty</button>
                                </div>
                                </form>
                                <hr class="my-6">
                                <h3 class="text-xl font-bold mb-4">Správa Vlastností (globální)</h3>
                                <p class="text-sm text-gray-500 mb-4">Přetáhněte položky pro změnu pořadí. Změny se projeví až po kliknutí na tlačítko "Uložit pořadí".</p>
                                <div id="features-settings-list" class="mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                                <div id="features-sort-controls" class="hidden mt-4 flex justify-end">
                                    <button id="save-features-order-btn" class="btn btn-primary">Uložit pořadí vlastností</button>
                                </div>
                                <form id="add-feature-form" class="space-y-4 p-4 border rounded-md mt-6">
                                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                         <div>
                                             <label for="new-feature-cz-input" class="block text-sm font-medium text-gray-700">Název CZ</label>
                                             <input type="text" id="new-feature-cz-input" class="input-field mt-1">
                                         </div>
                                         <div>
                                             <label for="new-feature-en-input" class="block text-sm font-medium text-gray-700">Název EN</label>
                                             <input type="text" id="new-feature-en-input" class="input-field mt-1">
                                         </div>
                                         <div>
                                             <label for="new-feature-de-input" class="block text-sm font-medium text-gray-700">Název DE</label>
                                             <input type="text" id="new-feature-de-input" class="input-field mt-1">
                                         </div>
                                     </div>
                                    <div class="flex gap-2 mt-4">
                                         <button id="add-feature-btn" type="submit" class="btn btn-primary w-full md:w-auto">Přidat vlastnost</button>
                                         <button id="cancel-edit-feature-btn" type="button" class="btn btn-secondary hidden">Zrušit úpravu</button>
                                    </div>
                                </form>
                         </div>

                        <!-- Country Specific Settings -->
                        <div class="mb-4 border-b border-gray-200">
                               <nav class="flex -mb-px" id="settings-tabs">
                                     <button type="button" data-country="bulharsko" class="tab-button active" style="padding-right: 15px;">Bulharsko</button>
                                     <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                               </nav>
                        </div>

                        <div id="country-specific-settings-container">
                            <!-- This container will be populated by JS -->
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
            query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAi_ugQSDUjk4y8ne4zpAyTbzNrf96SWDc",
            authDomain: "login-40bf8.firebaseapp.com",
            projectId: "login-40bf8",
            storageBucket: "gs://login-40bf8.appspot.com", // Corrected storage bucket URL
            messagingSenderId: "932200625165",
            appId: "1:932200625165:web:422564c4f9c3f9fbead144"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Initialize TinyMCE ---
        const initTinyMCE = (selector) => {
            tinymce.init({
                selector: selector,
                entity_encoding: 'raw',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
                height: 300,
            });
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            initTinyMCE('.tinymce-editor');
        });

        // --- Global state variables ---
        let filesToUpload = [];
        let existingImageUrls = [];
        let currentSettingsCountry = 'bulharsko';
        let currentPropertyListCountry = 'bulharsko';
        let currentEditFeature = null;
        let currentEditSetting = null; // NEW: For editing locations, types, rooms

        // --- UI Element Selectors ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        
        // Views
        const allViews = {
            propertyList: document.getElementById('property-list-view'),
            propertyForm: document.getElementById('property-form-view'),
            pageManagement: document.getElementById('page-management-view'),
            pageForm: document.getElementById('page-form-view'),
            tagManagement: document.getElementById('tag-management-view'),
            settings: document.getElementById('settings-view')
        };

        // Sidebar Buttons
        const sidebarButtons = {
            properties: document.getElementById('show-properties-btn'),
            pages: document.getElementById('show-pages-btn'),
            tags: document.getElementById('show-tags-btn'),
            settings: document.getElementById('show-settings-btn')
        };
        
        // --- Mobile Menu Toggle ---
        mobileMenuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // --- Helper Functions ---
        function slugify(text) {
            if (typeof text !== 'string') return '';
            const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
            const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
            const p = new RegExp(a.split('').join('|'), 'g')

            return text.toString().toLowerCase()
                .replace(/\s+/g, '-') 
                .replace(p, c => b.charAt(a.indexOf(c))) 
                .replace(/&/g, '-and-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, '') 
        }
        
        function handleFirestoreError(error, context = "Neznámá operace") {
            console.error(`Firestore Error during ${context}:`, error);
            const firestoreError = document.getElementById('firestore-error');
            firestoreError.innerHTML = `<strong>Chyba databáze (${context}):</strong> ${error.message}. Zkontrolujte konzoli pro více detailů.`;
            firestoreError.classList.remove('hidden');
        }

        function setEditorContent(editorId, content) {
             const editor = tinymce.get(editorId);
             if (editor) {
                 editor.setContent(content || '');
             } else {
                 console.warn(`Editor with ID ${editorId} not found.`);
             }
        }

        function getEditorContent(editorId) {
            const editor = tinymce.get(editorId);
            return editor ? editor.getContent() : '';
        }

        function renderList(type, items) {
            const containerId = type === 'features-settings' ? 'features-settings-list' : `${type}-list`;
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            
            // Do not sort features if it's the global settings list
            const sortable = type !== 'features-settings';

            const mappedItems = (items || []).map(item => {
                if (typeof item === 'object' && item !== null) {
                    const key = item.key || slugify(item.name_cz);
                    return { ...item, key: key, name: item.name_cz || key };
                }
                if (typeof item === 'string') {
                    return { name: item, key: slugify(item), name_cz: item, name_en: '', name_de: '' }; 
                }
                return null;
            }).filter(Boolean);

            if (sortable) {
                mappedItems.sort((a, b) => a.name.localeCompare(b.name, 'cs'));
            }

            mappedItems.forEach(item => {
                const dataType = type === 'features-settings' ? 'features-settings' : type;
                let displayHtml;
                const isSortableItem = type === 'features-settings';

                const itemHtml = `
                    <div class="flex-grow mr-4">
                        <strong class="text-gray-800">${item.name_cz || '(Chybí český název)'}</strong>
                        ${(type !== 'locations') ? `<div class="text-gray-500">
                            <span class="mr-3">EN: ${item.name_en || '-'}</span>
                            <span>DE: ${item.name_de || '-'}</span>
                        </div>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex items-center">
                        <button class="edit-setting-item-btn text-blue-600 hover:text-blue-900 mr-3" data-type="${dataType}" data-key="${item.key}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-setting-item-btn text-red-500 hover:text-red-700" data-type="${dataType}" data-key="${item.key}"><i class="fas fa-trash-alt"></i></button>
                    </div>`;

                const li = document.createElement('div');
                li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded text-sm';
                if (isSortableItem) {
                    li.classList.add('sortable-item');
                    li.dataset.key = item.key;
                }
                li.innerHTML = itemHtml;
                container.appendChild(li);
            });
        }
        
        function renderMenuItems(menuType, items) {
            const container = document.getElementById(`${menuType}-menu-list-${currentSettingsCountry}`);
            if (!container) return;
            container.innerHTML = '';
            (items || []).forEach(item => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                        <span>${item.title} -> /${item.slug}</span>
                        <button class="delete-menu-item-btn text-red-500 hover:text-red-700" data-menu-type="${menuType}" data-title="${item.title}" data-slug="${item.slug}">&times;</button>
                    </div>`;
            });
        }

        // --- App View Management ---
        function showView(viewName, buttonName) {
            Object.values(allViews).forEach(v => v.classList.add('hidden'));
            Object.values(sidebarButtons).forEach(b => b.classList.remove('active'));
            
            if (allViews[viewName]) allViews[viewName].classList.remove('hidden');
            if (sidebarButtons[buttonName]) sidebarButtons[buttonName].classList.add('active');
            
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in. The login function will handle the rest.
            } else {
                dashboard.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            adminLoginError.classList.add('hidden');

            const allowedAdminEmail = "xfiretin@gmail.com";

            if (email.toLowerCase() !== allowedAdminEmail.toLowerCase()) {
                adminLoginError.textContent = "Přístup odepřen. Tento účet nemá oprávnění k přihlášení.";
                adminLoginError.classList.remove('hidden');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    showView('propertyList', 'properties');
                    loadProperties(currentPropertyListCountry);
                } else {
                    adminLoginError.textContent = "Přístup odepřen. Tento účet nemá oprávnění administrátora.";
                    adminLoginError.classList.remove('hidden');
                    await signOut(auth);
                }

            } catch (error) {
                console.error("Chyba přihlášení:", error.code, error.message);
                adminLoginError.textContent = "Nesprávný email nebo heslo. Zkontrolujte prosím své přihlašovací údaje a zkuste to znovu.";
                adminLoginError.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', () => signOut(auth));

        // --- Sidebar Navigation ---
        sidebarButtons.properties.addEventListener('click', () => {
            showView('propertyList', 'properties');
            loadProperties(currentPropertyListCountry);
        });
        sidebarButtons.pages.addEventListener('click', () => {
            showView('pageManagement', 'pages');
            loadPages();
        });
        sidebarButtons.tags.addEventListener('click', () => {
            showView('tagManagement', 'tags');
            loadTags();
        });
        sidebarButtons.settings.addEventListener('click', () => {
            showView('settings', 'settings');
            loadGlobalSettings();
            loadAndRenderCountrySettings();
        });

        // --- Property Management ---
        const propertyForm = document.getElementById('property-form');
        const propertiesTableBody = document.getElementById('properties-table-body');
        const propertyCountryTabs = document.getElementById('property-country-tabs');
        
        propertyCountryTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPropertyListCountry = e.target.dataset.country;
                propertyCountryTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadProperties(currentPropertyListCountry);
            }
        });
        
        async function loadProperties(country) {
            try {
                const propertiesRef = collection(db, 'properties');
                const q = query(propertiesRef, where('country', '==', country));
                const querySnapshot = await getDocs(q);
                
                let properties = [];
                querySnapshot.forEach(doc => {
                    properties.push({ id: doc.id, ...doc.data() });
                });

                properties.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                propertiesTableBody.innerHTML = '';
                if (properties.length === 0) {
                    propertiesTableBody.innerHTML = '<tr><td colspan="7" class="table-cell text-center">Nebyly nalezeny žádné nemovitosti.</td></tr>';
                    return;
                }
                properties.forEach(prop => {
                    const firstImage = prop.images && prop.images.length > 0 ? prop.images[0] : 'https://placehold.co/100x60/eee/ccc?text=Foto';
                    const createdAt = prop.createdAt ? prop.createdAt.toDate().toLocaleDateString('cs-CZ') : 'N/A';
                    const statusClass = prop.status === 'Aktivní' ? 'active' : 'inactive';
                    const row = `
                        <tr id="${prop.id}">
                            <td class="table-cell font-mono">${prop.offerId || 'N/A'}</td>
                            <td class="table-cell"><img src="${firstImage}" alt="Foto nemovitosti" class="w-24 h-16 object-cover rounded mx-auto"></td>
                            <td class="table-cell">
                                <p class="text-gray-900 whitespace-no-wrap font-bold">${prop.title_cz || prop.title}</p>
                                <p class="text-gray-600 whitespace-no-wrap">${prop.location}, ${prop.country}</p>
                            </td>
                            <td class="table-cell text-red-600 font-bold">€${Number(prop.price).toLocaleString('de-DE')}</td>
                            <td class="table-cell">${createdAt}</td>
                            <td class="table-cell">
                                <span class="status-toggle ${statusClass}" data-id="${prop.id}">${prop.status || 'Neaktivní'}</span>
                            </td>
                            <td class="table-cell">
                                <button class="edit-property-btn text-blue-600 hover:text-blue-900 mr-4" data-id="${prop.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-property-btn text-red-600 hover:text-red-900" data-id="${prop.id}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                    propertiesTableBody.innerHTML += row;
                });
            } catch (error) {
                handleFirestoreError(error, 'Načítání nemovitostí');
            }
        }

        function resetPropertyForm() {
            propertyForm.reset();
            document.getElementById('property-id').value = '';
            document.getElementById('form-title').textContent = 'Přidat novou nemovitost';
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('property-offer-id').readOnly = false;
            ['cz', 'en', 'de'].forEach(lang => {
                setEditorContent(`property-description-${lang}`, '');
            });
            filesToUpload = [];
            existingImageUrls = [];
            document.getElementById('upload-progress').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '0%';
        }
        
        async function openNewPropertyForm() {
            resetPropertyForm();
            await populateFormDropdowns('bulharsko');
            await populateFeatures([]);
            showView('propertyForm', 'properties');
        }
        
        document.getElementById('add-property-btn').addEventListener('click', openNewPropertyForm);
        document.getElementById('cancel-form-btn').addEventListener('click', () => showView('propertyList', 'properties'));
        document.getElementById('property-country').addEventListener('change', async (e) => await populateFormDropdowns(e.target.value));

        propertyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Ukládám...';

            try {
                const newImageUrls = await uploadImages(filesToUpload);
                const allImageUrls = [...existingImageUrls, ...newImageUrls];
                const selectedFeatures = Array.from(document.querySelectorAll('#features-container input:checked')).map(cb => cb.value);

                const propertyData = {
                    title_cz: document.getElementById('property-title-cz').value,
                    description_cz: getEditorContent('property-description-cz'),
                    title_en: document.getElementById('property-title-en').value,
                    description_en: getEditorContent('property-description-en'),
                    title_de: document.getElementById('property-title-de').value,
                    description_de: getEditorContent('property-description-de'),
                    price: Number(document.getElementById('property-price').value),
                    offerId: Number(document.getElementById('property-offer-id').value),
                    offerType: document.getElementById('property-offer-type').value,
                    country: document.getElementById('property-country').value,
                    location: document.getElementById('property-location').value,
                    type: document.getElementById('property-type').value,
                    rooms: document.getElementById('property-rooms').value,
                    floor: Number(document.getElementById('property-floor').value) || null,
                    area: Number(document.getElementById('property-area').value) || null,
                    images: allImageUrls,
                    features: selectedFeatures,
                    status: document.getElementById('property-status').value,
                    lastUpdated: serverTimestamp()
                };

                const id = document.getElementById('property-id').value;
                if (id) {
                    await updateDoc(doc(db, 'properties', id), propertyData);
                } else {
                    propertyData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'properties'), propertyData);
                }
                
                showView('propertyList', 'properties');
                loadProperties(currentPropertyListCountry);
            } catch (error) {
                handleFirestoreError(error, 'Ukládání nemovitosti');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Uložit nemovitost';
            }
        });

        propertiesTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button, span');
            if (!button) return;
            const id = button.dataset.id;
            
            if (button.classList.contains('status-toggle')) {
                const currentStatus = button.textContent;
                const newStatus = currentStatus === 'Aktivní' ? 'Neaktivní' : 'Aktivní';
                try {
                    await updateDoc(doc(db, 'properties', id), { status: newStatus });
                    loadProperties(currentPropertyListCountry);
                } catch (error) {
                    handleFirestoreError(error, 'Změna stavu nemovitosti');
                }
            }

            if (button.classList.contains('delete-property-btn')) {
                if (confirm('Opravdu chcete smazat tuto nemovitost? Tato akce je nevratná a smaže i všechny fotografie.')) {
                    try {
                        const propertyRef = doc(db, 'properties', id);
                        const docSnap = await getDoc(propertyRef);
                        
                        if (docSnap.exists()) {
                            const propertyData = docSnap.data();
                            if (propertyData.images && propertyData.images.length > 0) {
                                const deletePromises = propertyData.images.map(imageUrl => {
                                    try {
                                        const imageRef = ref(storage, imageUrl);
                                        return deleteObject(imageRef);
                                    } catch (err) {
                                        console.warn("Could not delete file:", imageUrl, err);
                                        return Promise.resolve();
                                    }
                                });
                                await Promise.all(deletePromises);
                            }
                        }
                        await deleteDoc(propertyRef);
                        document.getElementById(id).remove();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání nemovitosti');
                    }
                }
            }
            
            if (button.classList.contains('edit-property-btn')) {
                try {
                    const docRef = doc(db, 'properties', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const prop = docSnap.data();
                        
                        resetPropertyForm();
                        
                        document.getElementById('property-id').value = docSnap.id;
                        document.getElementById('form-title').textContent = 'Upravit nemovitost';
                        
                        document.getElementById('property-title-cz').value = prop.title_cz || prop.title || '';
                        document.getElementById('property-title-en').value = prop.title_en || '';
                        document.getElementById('property-title-de').value = prop.title_de || '';
                        setEditorContent('property-description-cz', prop.description_cz || prop.description || '');
                        setEditorContent('property-description-en', prop.description_en || '');
                        setEditorContent('property-description-de', prop.description_de || '');

                        document.getElementById('property-price').value = prop.price;
                        document.getElementById('property-offer-id').value = prop.offerId;
                        document.getElementById('property-offer-type').value = prop.offerType || 'prodej';
                        document.getElementById('property-country').value = prop.country;
                        document.getElementById('property-floor').value = prop.floor;
                        document.getElementById('property-area').value = prop.area;
                        document.getElementById('property-status').value = prop.status || 'Aktivní';
                        existingImageUrls = prop.images || [];
                        
                        await populateFormDropdowns(prop.country, prop);
                        await populateFeatures(prop.features || []);
                        
                        showView('propertyForm', 'properties');
                        previewImages();
                    }
                } catch (error) {
                    handleFirestoreError(error, 'Editace nemovitosti');
                }
            }
        });

        // --- Image Handling with Drag and Drop ---
        const dropZone = document.getElementById('image-drop-zone');
        const fileInput = document.getElementById('image-upload');

        fileInput.addEventListener('change', (e) => {
            filesToUpload.push(...e.target.files);
            previewImages();
            fileInput.value = ''; 
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            
            const droppedFiles = e.dataTransfer.files;
            if (droppedFiles.length > 0) {
                const imageFiles = Array.from(droppedFiles).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length > 0) {
                    filesToUpload.push(...imageFiles);
                    previewImages();
                } else {
                    alert('Některé přetažené soubory nebyly obrázky a byly ignorovány.');
                }
            }
        });

        function previewImages() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            const allImages = [
                ...existingImageUrls.map((url, index) => ({ type: 'existing', data: url, index })),
                ...filesToUpload.map((file, index) => ({ type: 'new', data: file, index }))
            ];

            allImages.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                const imgTag = document.createElement('img');
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.dataset.type = img.type;
                removeBtn.dataset.index = img.index;
                item.append(imgTag, removeBtn);
                container.appendChild(item);
                imgTag.src = (img.type === 'existing') ? img.data : URL.createObjectURL(img.data);
            });
        }
        
        document.getElementById('image-preview-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-image-btn')) {
                const type = e.target.dataset.type;
                const index = parseInt(e.target.dataset.index, 10);
                if (type === 'new') filesToUpload.splice(index, 1);
                else if (type === 'existing') existingImageUrls.splice(index, 1);
                previewImages();
            }
        });

        async function uploadImages(files) {
            if (files.length === 0) return [];
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('upload-status');
            progressContainer.classList.remove('hidden');
            const imageUrls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = `${Date.now()}-${file.name}`;
                const storageRef = ref(storage, `properties/${fileName}`);
                try {
                    statusText.textContent = `Nahrávám obrázek ${i + 1} z ${files.length}...`;
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    imageUrls.push(url);
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                } catch (error) {
                    console.error("Chyba při nahrávání obrázku:", error);
                    statusText.textContent = `Chyba při nahrávání obrázku: ${file.name}`;
                }
            }
            return imageUrls;
        }

        // --- Page Management ---
        const pagesTableBody = document.getElementById('pages-table-body');
        const pageForm = document.getElementById('page-form');
        
        async function loadPages() {
            try {
                const pagesRef = collection(db, 'pages');
                const q = query(pagesRef, orderBy('title_cz'));
                const querySnapshot = await getDocs(q);
                pagesTableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const page = doc.data();
                    const statusClass = page.status === 'Aktivní' ? 'active' : 'inactive';
                    pagesTableBody.innerHTML += `
                        <tr id="page-${doc.id}">
                            <td class="table-cell font-bold">${page.title_cz}</td>
                            <td class="table-cell">/${page.slug}</td>
                            <td class="table-cell"><span class="status-toggle ${statusClass}">${page.status || 'Neaktivní'}</span></td>
                            <td class="table-cell">
                                <button class="edit-page-btn text-blue-600 hover:text-blue-900 mr-4" data-id="${doc.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-page-btn text-red-600 hover:text-red-900" data-id="${doc.id}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                handleFirestoreError(error, 'Načítání stránek');
            }
        }

        function resetPageForm() {
            pageForm.reset();
            document.getElementById('page-id').value = '';
            ['cz', 'en', 'de'].forEach(lang => {
                setEditorContent(`page-content-${lang}`, '');
            });
            document.getElementById('page-form-title').textContent = 'Přidat novou stránku';
        }

        document.getElementById('add-page-btn').addEventListener('click', () => {
            resetPageForm();
            showView('pageForm', 'pages');
        });
        document.getElementById('cancel-page-form-btn').addEventListener('click', () => showView('pageManagement', 'pages'));
        document.getElementById('page-title-cz').addEventListener('input', (e) => {
            document.getElementById('page-slug').value = slugify(e.target.value);
        });

        pageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('page-id').value;
            const pageData = {
                slug: document.getElementById('page-slug').value,
                status: document.getElementById('page-status').value,
                title_cz: document.getElementById('page-title-cz').value,
                content_cz: getEditorContent('page-content-cz'),
                title_en: document.getElementById('page-title-en').value,
                content_en: getEditorContent('page-content-en'),
                title_de: document.getElementById('page-title-de').value,
                content_de: getEditorContent('page-content-de'),
            };
            try {
                if (id) {
                    await updateDoc(doc(db, 'pages', id), pageData);
                } else {
                    await addDoc(collection(db, 'pages'), pageData);
                }
                showView('pageManagement', 'pages');
                loadPages();
            } catch (error) {
                handleFirestoreError(error, 'Ukládání stránky');
            }
        });

        pagesTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            if (button.classList.contains('delete-page-btn')) {
                if (confirm('Opravdu chcete smazat tuto stránku?')) {
                    try {
                        await deleteDoc(doc(db, 'pages', id));
                        loadPages();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání stránky');
                    }
                }
            }
            if (button.classList.contains('edit-page-btn')) {
                try {
                    const docRef = doc(db, 'pages', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const page = docSnap.data();
                        resetPageForm();
                        document.getElementById('page-id').value = id;
                        document.getElementById('page-slug').value = page.slug;
                        document.getElementById('page-status').value = page.status || 'Aktivní';
                        document.getElementById('page-title-cz').value = page.title_cz || '';
                        document.getElementById('page-title-en').value = page.title_en || '';
                        document.getElementById('page-title-de').value = page.title_de || '';
                        setEditorContent('page-content-cz', page.content_cz || '');
                        setEditorContent('page-content-en', page.content_en || '');
                        setEditorContent('page-content-de', page.content_de || '');
                        document.getElementById('page-form-title').textContent = 'Upravit stránku';
                        showView('pageForm', 'pages');
                    }
                } catch (error) {
                    handleFirestoreError(error, 'Editace stránky');
                }
            }
        });

        // --- Tag Management ---
        async function loadTags() {
            const container = document.getElementById('tags-list');
            container.innerHTML = '<p>Načítání tagů...</p>';
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                const settingsDocSnap = await getDoc(settingsDocRef);
                const tags = settingsDocSnap.exists() ? settingsDocSnap.data().tags || [] : [];
                renderTags(tags);
            } catch (error) {
                handleFirestoreError(error, 'Načítání tagů');
            }
        }

        function renderTags(tags) {
            const container = document.getElementById('tags-list');
            container.innerHTML = '';
            if (tags.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Zatím nebyly přidány žádné tagy.</p>';
                return;
            }
            tags.sort().forEach(tag => {
                container.innerHTML += `
                    <div class="inline-flex items-center bg-blue-100 text-blue-800 text-sm font-medium pl-3 pr-2 py-1 rounded-full">
                        <span>${tag}</span>
                        <button class="delete-tag-btn ml-2 text-blue-600 hover:text-red-700 font-bold rounded-full w-5 h-5 flex items-center justify-center transition-colors" data-tag="${tag}">&times;</button>
                    </div>`;
            });
        }

        document.getElementById('add-tag-btn').addEventListener('click', async (e) => {
            e.preventDefault(); 
            const input = document.getElementById('new-tag-input');
            const tag = input.value.trim();
            if (!tag) return;
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                await setDoc(settingsDocRef, {
                    tags: arrayUnion(tag)
                }, { merge: true });
                input.value = '';
                loadTags();
            } catch (error) {
                handleFirestoreError(error, 'Přidání tagu');
            }
        });

        document.getElementById('tags-list').addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-tag-btn');
            if (deleteButton) {
                e.preventDefault();
                const tag = deleteButton.dataset.tag;
                if (confirm(`Opravdu chcete smazat tag "${tag}"?`)) {
                    try {
                        const settingsDocRef = doc(db, 'settings', 'global');
                        await updateDoc(settingsDocRef, {
                            tags: arrayRemove(tag)
                        });
                        loadTags();
                    } catch (error) {
                        handleFirestoreError(error, 'Smazání tagu');
                    }
                }
            }
        });

        // --- Settings Management ---
        const settingsTabs = document.getElementById('settings-tabs');
        
        settingsTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentSettingsCountry = e.target.dataset.country;
                settingsTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadAndRenderCountrySettings();
            }
        });

        function createSingleLangInputForm(type, label) {
             return `
                 <form id="add-${type}-form" class="p-4 border rounded-md">
                     <div class="flex flex-col gap-4">
                         <input type="text" id="new-${type}-cz-input" placeholder="Název (CZ)" class="input-field">
                         <div class="flex gap-2">
                             <button type="submit" class="btn btn-primary whitespace-nowrap w-full add-setting-item-btn" data-type="${type}s">Přidat ${label}</button>
                             <button type="button" class="btn btn-secondary w-full hidden cancel-edit-setting-btn" data-type="${type}">Zrušit</button>
                         </div>
                     </div>
                 </form>
            `;
        }

        function createMultilangInputForm(type, label) {
            return `
                 <form id="add-${type}-form" class="space-y-4 p-4 border rounded-md">
                     <div class="space-y-2">
                         <label for="new-${type}-cz-input" class="block text-sm font-medium text-gray-700">Název CZ</label>
                         <input type="text" id="new-${type}-cz-input" class="input-field">
                         <label for="new-${type}-en-input" class="block text-sm font-medium text-gray-700">Název EN</label>
                         <input type="text" id="new-${type}-en-input" class="input-field">
                         <label for="new-${type}-de-input" class="block text-sm font-medium text-gray-700">Název DE</label>
                         <input type="text" id="new-${type}-de-input" class="input-field">
                     </div>
                     <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary w-full add-setting-item-btn" data-type="${type}s">Přidat ${label}</button>
                        <button type="button" class="btn btn-secondary w-full hidden cancel-edit-setting-btn" data-type="${type}">Zrušit</button>
                     </div>
                 </form>
            `;
        }

        function renderCountrySettingsHTML(country, settings) {
            const countryCapitalized = country.charAt(0).toUpperCase() + country.slice(1);
            return `
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-xl font-bold mb-4">Nastavení pro ${countryCapitalized}</h3>
                    <form id="${country}-settings-form">
                        <div class="mb-4">
                            <label for="setting-logo-text-${country}" class="block text-gray-700 font-bold mb-2">Text loga</label>
                            <input type="text" id="setting-logo-text-${country}" class="input-field" value="${settings.logoText || ''}">
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="submit" class="btn btn-primary">Uložit nastavení pro ${countryCapitalized}</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-xl font-bold mb-4">Správa menu pro ${countryCapitalized}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold mb-2">Menu "Informace"</h4>
                            <div id="info-menu-list-${country}" class="mb-4 space-y-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-info-menu-title-${country}" placeholder="Název položky" class="input-field">
                                <select id="new-info-menu-link-${country}" class="input-field"></select>
                                <button data-menu-type="info" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-2">Menu "Naše služby"</h4>
                            <div id="services-menu-list-${country}" class="mb-4 space-y-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-services-menu-title-${country}" placeholder="Název položky" class="input-field">
                                <select id="new-services-menu-link-${country}" class="input-field"></select>
                                <button data-menu-type="services" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Správa Lokalit</h3>
                        <div id="locations-list" class="mb-4 space-y-2"></div>
                        ${createSingleLangInputForm('location', 'lokalitu')}
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Správa Druhů Nemovitostí</h3>
                        <div id="types-list" class="mb-4 space-y-2"></div>
                        ${createMultilangInputForm('type', 'druh')}
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                       <h3 class="text-xl font-bold mb-4">Správa Dispozic</h3>
                       <div id="rooms-list" class="mb-4 space-y-2"></div>
                       ${createMultilangInputForm('room', 'dispozici')}
                   </div>
                </div>
            `;
        }
        
        async function loadAndRenderCountrySettings() {
            const container = document.getElementById('country-specific-settings-container');
            try {
                const settingsDocRef = doc(db, 'settings', currentSettingsCountry);
                const settingsDocSnap = await getDoc(settingsDocRef);
                const settings = settingsDocSnap.exists() ? settingsDocSnap.data() : {};
                container.innerHTML = renderCountrySettingsHTML(currentSettingsCountry, settings);
                
                const pagesSnapshot = await getDocs(collection(db, 'pages'));
                const infoMenuLink = document.getElementById(`new-info-menu-link-${currentSettingsCountry}`);
                const servicesMenuLink = document.getElementById(`new-services-menu-link-${currentSettingsCountry}`);
                infoMenuLink.innerHTML = '<option value="">-- Vyberte stránku --</option>';
                servicesMenuLink.innerHTML = '<option value="">-- Vyberte stránku --</option>';
                pagesSnapshot.forEach(doc => {
                    const page = doc.data();
                    const statusIndicator = page.status === 'Aktivní' ? '✓' : '✗';
                    const optionText = `${page.title_cz} (${statusIndicator})`;
                    const option = new Option(optionText, page.slug);
                    if (page.status !== 'Aktivní') {
                        option.disabled = true;
                        option.style.color = '#ccc';
                    }
                    infoMenuLink.add(option.cloneNode(true));
                    servicesMenuLink.add(option);
                });

                renderMenuItems('info', settings.infoMenu || []);
                renderMenuItems('services', settings.servicesMenu || []);
                renderList('locations', settings.locations || []);
                renderList('types', settings.types || []);
                renderList('rooms', settings.rooms || []);

            } catch (error) {
                handleFirestoreError(error, `Načítání nastavení pro ${currentSettingsCountry}`);
            }
        }

        async function loadGlobalSettings() {
            try {
                const docRef = doc(db, 'settings', 'global');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('setting-contact1-name').value = data.contact1_name || '';
                    document.getElementById('setting-contact1-phone').value = data.contact1_phone || '';
                    document.getElementById('setting-contact1-phone2').value = data.contact1_phone2 || '';
                    document.getElementById('setting-contact1-email').value = data.contact1_email || '';
                    document.getElementById('setting-contact2-name').value = data.contact2_name || '';
                    document.getElementById('setting-contact2-phone').value = data.contact2_phone || '';
                    document.getElementById('setting-contact2-phone2').value = data.contact2_phone2 || '';
                    document.getElementById('setting-contact2-email').value = data.contact2_email || '';
                    renderList('features-settings', data.features || []);
                    initSortableFeatures(); // Initialize drag-and-drop
                }
            } catch (error) {
                handleFirestoreError(error, 'Načítání globálních nastavení');
            }
        }

        document.getElementById('global-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Ukládám...';
            try {
                const data = {
                    contact1_name: document.getElementById('setting-contact1-name').value,
                    contact1_phone: document.getElementById('setting-contact1-phone').value,
                    contact1_phone2: document.getElementById('setting-contact1-phone2').value,
                    contact1_email: document.getElementById('setting-contact1-email').value,
                    contact2_name: document.getElementById('setting-contact2-name').value,
                    contact2_phone: document.getElementById('setting-contact2-phone').value,
                    contact2_phone2: document.getElementById('setting-contact2-phone2').value,
                    contact2_email: document.getElementById('setting-contact2-email').value,
                };
                await setDoc(doc(db, 'settings', 'global'), data, { merge: true });
                alert('Globální kontakty byly uloženy.');
            } catch (error) {
                handleFirestoreError(error, 'Ukládání globálních kontaktů');
            } finally {
                button.disabled = false;
                button.textContent = 'Uložit globální kontakty';
            }
        });

        const addFeatureForm = document.getElementById('add-feature-form');
        const addFeatureBtn = document.getElementById('add-feature-btn');
        const cancelEditFeatureBtn = document.getElementById('cancel-edit-feature-btn');

        function resetAddFeatureForm() {
            addFeatureForm.reset();
            currentEditFeature = null;
            addFeatureBtn.textContent = 'Přidat vlastnost';
            cancelEditFeatureBtn.classList.add('hidden');
        }

        cancelEditFeatureBtn.addEventListener('click', resetAddFeatureForm);

        addFeatureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const czInput = document.getElementById('new-feature-cz-input');
            const enInput = document.getElementById('new-feature-en-input');
            const deInput = document.getElementById('new-feature-de-input');
            const czName = czInput.value.trim();

            if (!czName) {
                alert('Český název je povinný.');
                return;
            }

            const newFeatureData = {
                key: currentEditFeature ? currentEditFeature.key : slugify(czName), // Preserve key on edit
                name_cz: czName,
                name_en: enInput.value.trim(),
                name_de: deInput.value.trim()
            };

            button.disabled = true;
            const settingsDocRef = doc(db, 'settings', 'global');

            try {
                const docSnap = await getDoc(settingsDocRef);
                let features = (docSnap.exists() && docSnap.data().features) ? docSnap.data().features : [];

                if (currentEditFeature) { // UPDATE LOGIC
                    button.textContent = 'Ukládám...';
                    const featureIndex = features.findIndex(f => f.key === currentEditFeature.key);
                    if (featureIndex > -1) {
                         features[featureIndex] = newFeatureData;
                    }
                } else { // ADD LOGIC
                    button.textContent = 'Přidávám...';
                    features.push(newFeatureData);
                }
                await updateDoc(settingsDocRef, { features: features });
                resetAddFeatureForm();
                await loadGlobalSettings();
            } catch (error) {
                handleFirestoreError(error, currentEditFeature ? 'Úprava vlastnosti' : 'Přidání vlastnosti');
            } finally {
                button.disabled = false;
                resetAddFeatureForm();
            }
        });

        function initSortableFeatures() {
            const list = document.getElementById('features-settings-list');
            if (list) {
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        document.getElementById('features-sort-controls').classList.remove('hidden');
                    },
                });
            }
        }

        document.getElementById('save-features-order-btn').addEventListener('click', async (e) => {
            const button = e.target;
            button.disabled = true;
            button.textContent = 'Ukládám...';

            const list = document.getElementById('features-settings-list');
            const newKeyOrder = Array.from(list.children).map(item => item.dataset.key);
            
            const settingsDocRef = doc(db, 'settings', 'global');
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let features = data.features || [];
                    
                    const reorderedFeatures = newKeyOrder.map(key => {
                        return features.find(f => f.key === key);
                    }).filter(Boolean); // Filter out any undefined if a feature was deleted

                    await updateDoc(settingsDocRef, { features: reorderedFeatures });
                    alert('Pořadí vlastností bylo uloženo.');
                    document.getElementById('features-sort-controls').classList.add('hidden');
                }
            } catch (error) {
                handleFirestoreError(error, 'Ukládání pořadí vlastností');
            } finally {
                button.disabled = false;
                button.textContent = 'Uložit pořadí vlastností';
            }
        });

        document.getElementById('settings-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            // Handle Cancel Edit for country-specific settings
            if (button.classList.contains('cancel-edit-setting-btn')) {
                const type = button.dataset.type;
                const form = document.getElementById(`add-${type}-form`);
                form.reset();
                currentEditSetting = null;
                const addButton = form.querySelector('.add-setting-item-btn');
                addButton.textContent = addButton.textContent.replace('Uložit', 'Přidat');
                button.classList.add('hidden');
                return;
            }

            if (button.classList.contains('edit-setting-item-btn')) {
                e.preventDefault();
                const key = button.dataset.key;
                const type = button.dataset.type;
                const isGlobal = type === 'features-settings';
                const docId = isGlobal ? 'global' : currentSettingsCountry;
                
                const docRef = doc(db, 'settings', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const arrayName = isGlobal ? 'features' : type;
                    const items = docSnap.data()[arrayName] || [];
                    const itemToEdit = items.find(item => (item.key || slugify(item)) === key);

                    if(itemToEdit) {
                        if (isGlobal) {
                            currentEditFeature = itemToEdit;
                            document.getElementById('new-feature-cz-input').value = itemToEdit.name_cz || '';
                            document.getElementById('new-feature-en-input').value = itemToEdit.name_en || '';
                            document.getElementById('new-feature-de-input').value = itemToEdit.name_de || '';
                            addFeatureBtn.textContent = 'Uložit změny';
                            cancelEditFeatureBtn.classList.remove('hidden');
                            addFeatureForm.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            currentEditSetting = { type: type, key: key };
                            const form = document.getElementById(`add-${type.replace(/s$/, '')}-form`);
                            form.querySelector(`#new-${type.replace(/s$/, '')}-cz-input`).value = typeof itemToEdit === 'object' ? itemToEdit.name_cz : itemToEdit;
                            if (typeof itemToEdit === 'object') {
                                form.querySelector(`#new-${type.replace(/s$/, '')}-en-input`).value = itemToEdit.name_en || '';
                                form.querySelector(`#new-${type.replace(/s$/, '')}-de-input`).value = itemToEdit.name_de || '';
                            }
                            form.querySelector('.add-setting-item-btn').textContent = 'Uložit změny';
                            form.querySelector('.cancel-edit-setting-btn').classList.remove('hidden');
                            form.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                }
                return;
            }

            if (button.closest('form')?.id === `${currentSettingsCountry}-settings-form`) {
                e.preventDefault();
                button.disabled = true;
                button.textContent = 'Ukládám...';
                try {
                    const data = {
                        logoText: document.getElementById(`setting-logo-text-${currentSettingsCountry}`).value,
                    };
                    await setDoc(doc(db, 'settings', currentSettingsCountry), data, { merge: true });
                    alert(`Nastavení pro ${currentSettingsCountry} bylo uloženo.`);
                } catch (error) {
                    handleFirestoreError(error, `Ukládání nastavení pro ${currentSettingsCountry}`);
                } finally {
                    button.disabled = false;
                    button.textContent = `Uložit nastavení pro ${currentSettingsCountry}`;
                }
                return;
            }
            
            if (button.classList.contains('add-setting-item-btn')) {
                e.preventDefault();
                const form = button.closest('form');
                const type = button.dataset.type;
                const typeSingle = type.replace(/s$/, '');
                
                const czInput = form.querySelector(`#new-${typeSingle}-cz-input`);
                const enInput = form.querySelector(`#new-${typeSingle}-en-input`);
                const deInput = form.querySelector(`#new-${typeSingle}-de-input`);

                const czName = czInput.value.trim();
                if (!czName) {
                    alert('Název je povinný.');
                    return;
                }
                
                let newItem;
                if(type === 'locations') {
                    newItem = czName;
                } else {
                    newItem = {
                        key: currentEditSetting ? currentEditSetting.key : slugify(czName),
                        name_cz: czName,
                        name_en: enInput ? enInput.value.trim() : '',
                        name_de: deInput ? deInput.value.trim() : ''
                    };
                }

                button.disabled = true;
                button.textContent = 'Ukládám...';
                const settingsDocRef = doc(db, 'settings', currentSettingsCountry);

                try {
                    const docSnap = await getDoc(settingsDocRef);
                    let items = (docSnap.exists() && docSnap.data()[type]) ? docSnap.data()[type] : [];

                    if (currentEditSetting && currentEditSetting.type === type) { // UPDATE
                        const itemIndex = items.findIndex(item => (item.key || slugify(item)) === currentEditSetting.key);
                        if (itemIndex > -1) {
                            items[itemIndex] = newItem;
                        }
                    } else { // ADD
                        items.push(newItem);
                    }

                    await updateDoc(settingsDocRef, { [type]: items });
                    
                    form.reset();
                    currentEditSetting = null;
                    form.querySelector('.cancel-edit-setting-btn').classList.add('hidden');
                    
                    await loadAndRenderCountrySettings();
                } catch (error) {
                    handleFirestoreError(error, `Ukládání položky do ${type}`);
                } finally {
                    button.disabled = false;
                    button.textContent = button.textContent.replace('Ukládám...', 'Přidat');
                }
                return;
            }

            if (button.classList.contains('delete-setting-item-btn')) {
                e.preventDefault();
                const key = button.dataset.key;
                const type = button.dataset.type;
                const isGlobal = type === 'features-settings';
                const docId = isGlobal ? 'global' : currentSettingsCountry;
                const arrayName = isGlobal ? 'features' : type;

                if (!key) { console.error("Delete button is missing a key."); return; }

                if (confirm(`Opravdu chcete smazat tuto položku?`)) {
                    try {
                        const docRef = doc(db, 'settings', docId);
                        const docSnap = await getDoc(docRef);
                        if (!docSnap.exists()) return;

                        const data = docSnap.data();
                        let items = data[arrayName] || [];
                        const updatedItems = items.filter(item => (item.key || slugify(item)) !== key);
                        
                        await updateDoc(docRef, { [arrayName]: updatedItems });
                        
                        if (isGlobal) await loadGlobalSettings();
                        else await loadAndRenderCountrySettings();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání položky');
                    }
                }
                return;
            }
            
            if (button.classList.contains('add-menu-item-btn')) {
                e.preventDefault();
                const menuType = button.dataset.menuType;
                const titleInput = document.getElementById(`new-${menuType}-menu-title-${currentSettingsCountry}`);
                const linkSelect = document.getElementById(`new-${menuType}-menu-link-${currentSettingsCountry}`);
                const title = titleInput.value.trim();
                const slug = linkSelect.value;
                
                if (!title || !slug) {
                    alert('Prosím vyplňte název i odkaz.');
                    return;
                }
                
                const value = { title, slug };
                const arrayName = `${menuType}Menu`;
                
                try {
                    await setDoc(doc(db, 'settings', currentSettingsCountry), {
                        [arrayName]: arrayUnion(value)
                    }, { merge: true });
                    titleInput.value = '';
                    linkSelect.value = '';
                    await loadAndRenderCountrySettings();
                } catch (error) {
                    handleFirestoreError(error, `Přidání položky do menu ${menuType}`);
                }
                return;
            }

            if (button.classList.contains('delete-menu-item-btn')) {
                e.preventDefault();
                const menuType = button.dataset.menuType;
                const title = button.dataset.title;
                const slug = button.dataset.slug;
                const itemToRemove = { title, slug };
                const arrayName = `${menuType}Menu`;

                if (confirm(`Opravdu chcete smazat položku menu "${title}"?`)) {
                    try {
                        await updateDoc(doc(db, 'settings', currentSettingsCountry), {
                            [arrayName]: arrayRemove(itemToRemove)
                        });
                        await loadAndRenderCountrySettings();
                    } catch (error) {
                        handleFirestoreError(error, `Mazání položky z menu ${menuType}`);
                    }
                }
                return;
            }
        });
        
        async function populateFormDropdowns(country, propertyData = {}) {
            const selects = {
                location: document.getElementById('property-location'),
                type: document.getElementById('property-type'),
                rooms: document.getElementById('property-rooms')
            };
            Object.values(selects).forEach(s => s.innerHTML = '<option value="">Načítání...</option>');
            
            try {
                const settingsDocRef = doc(db, 'settings', country);
                const settingsDocSnap = await getDoc(settingsDocRef);
                
                if (!settingsDocSnap.exists()) { 
                    Object.values(selects).forEach(s => s.innerHTML = '<option value="">Žádná data pro tuto zemi</option>');
                     return;
                }
                const settings = settingsDocSnap.data();

                const populateSelect = (selectElement, items, selectedValue) => {
                    selectElement.innerHTML = `<option value="">-- Vyberte --</option>`;
                    
                    if (!Array.isArray(items)) {
                        console.warn("Data pro select nejsou polem:", items);
                        return;
                    }

                    const getName = (item) => {
                        if (typeof item === 'object' && item !== null && item.name_cz) return item.name_cz;
                        if (typeof item === 'string' && item) return item;
                        return '';
                    };
                    
                    const sortable = true; // All dropdowns should be sorted alphabetically
                    const mappedItems = items.map(item => ({ text: getName(item), value: getName(item) })).filter(item => item.value);

                    if (sortable) {
                       mappedItems.sort((a, b) => a.text.localeCompare(b.text, 'cs'));
                    }

                    mappedItems.forEach(item => {
                        const option = new Option(item.text, item.value);
                        if (item.value === selectedValue) {
                            option.selected = true;
                        }
                        selectElement.add(option);
                    });
                };
                
                populateSelect(selects.location, settings.locations || [], propertyData.location);
                populateSelect(selects.type, settings.types || [], propertyData.type);
                populateSelect(selects.rooms, settings.rooms || [], propertyData.rooms);

            } catch (error) {
                console.error("Chyba při načítání nastavení pro formulář:", error);
                Object.values(selects).forEach(s => s.innerHTML = '<option value="">Chyba načítání</option>');
            }
        }

        async function populateFeatures(selectedFeatures = []) {
            const container = document.getElementById('features-container');
            container.innerHTML = '';
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                const settingsDocSnap = await getDoc(settingsDocRef);
                const settings = settingsDocSnap.exists() ? settingsDocSnap.data() : { features: [] };
                // Use saved order, do not sort here
                (settings.features || []).forEach(feature => {
                    const checked = selectedFeatures.includes(feature.key) ? 'checked' : '';
                    container.innerHTML += `
                        <div class="feature-item">
                            <input type="checkbox" id="feature-${feature.key}" value="${feature.key}" ${checked} class="feature-checkbox">
                            <label for="feature-${feature.key}">${feature.name_cz}</label>
                        </div>`;
                });
            } catch (error) {
                console.error("Chyba při načítání vlastností:", error);
                container.innerHTML = '<p>Chyba při načítání vlastností.</p>';
            }
        }

        function setupTabSwitching(tabsId, contentClass) {
            const tabsContainer = document.getElementById(tabsId);
            if (!tabsContainer) return;
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const lang = e.target.dataset.lang;
                    tabsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll(`.${contentClass}`).forEach(content => {
                        if (content.id.includes(`-${lang}`)) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                }
            });
        }

        setupTabSwitching('property-lang-tabs', 'lang-tab-content');
        setupTabSwitching('page-lang-tabs', 'lang-tab-content');

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Správa obsahu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Editor textu -->
    <script src="https://cdn.tiny.cloud/1/t62v88urbx396otieiqu7apcy81f9ulf00f3eb24ym4s0x2c/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <!-- Knihovny pro ZIP a stahování -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Tesseract.js pro čtení textu z obrázků (OCR) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        /* Custom Tailwind directives for cleaner HTML */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        @layer components {
            .btn { @apply font-bold py-2 px-4 rounded transition duration-200; }
            .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white disabled:bg-blue-400; }
            .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
            .btn-danger { @apply bg-red-500 hover:bg-red-700 text-white; }
            /* Styl pro stahovací tlačítko */
            .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
            
            .btn-ai { @apply bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white hover:from-indigo-600 hover:to-pink-600 shadow-lg transform hover:scale-105 transition-all duration-300; }

            .table-header { @apply px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap; }
            .table-cell { @apply px-5 py-5 border-b border-gray-200 bg-white text-sm align-middle text-center; }
            .input-field { @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline; }
            .sidebar-link { @apply block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700; }
            .sidebar-link.active { @apply bg-gray-600 font-bold; }
            .tab-button { @apply px-4 py-2 font-semibold text-gray-600 rounded-t-lg transition-colors duration-200; }
            .tab-button.active { @apply bg-white text-blue-600 border-b-2 border-blue-600; }
            .status-toggle { @apply cursor-pointer font-bold py-1 px-3 rounded-full text-xs; }
            .status-toggle.active { @apply bg-green-100 text-green-800; }
            .status-toggle.inactive { @apply bg-red-100 text-red-800; }
        }
        
        /* Custom styles for UI elements */
        .hidden { display: none; }
        .error-message { color: #D8000C; background-color: #FFD2D2; border: 1px solid #D8000C; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        .image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 0.5rem; }
        .remove-image-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .feature-item { @apply flex items-center; }
        .feature-item input { @apply w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500; }
        .feature-item label { @apply ml-2 text-sm font-medium text-gray-900; }
        .lang-tab-content { display: none; }
        .lang-tab-content.active { display: block; }

        /* Style for SEO tags list */
        #tags-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 0.5rem;
        }

        /* --- DRAG & DROP STYLES --- */
        .drop-zone-container {
            border: 2px dashed #dde2e5;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #fafbfc;
            transition: border-color 0.2s, background-color 0.2s;
            cursor: pointer;
            position: relative;
            margin-bottom: 15px;
        }

        .drop-zone-container.drag-over {
            border-color: #2563eb; /* Tailwind blue-600 */
            background-color: #eff6ff; /* Tailwind blue-50 */
        }

        .upload-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-upload {
            background-color: #e8f0fe;
            color: #1967d2;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-upload:hover {
            background-color: #d2e3fc;
        }

        .drag-hint {
            display: block;
            margin-top: 10px;
            font-size: 13px;
            color: #9ca3af; /* Tailwind gray-400 */
        }

        /* --- AI ASSISTANT STYLES --- */
        .ai-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .ai-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .ai-modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ai-modal-overlay.active .ai-modal-content {
            transform: translateY(0);
        }

        .ai-textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }
        .ai-textarea:focus {
            outline: 2px solid #6366f1;
            border-color: transparent;
        }

        /* Styles for Image Drop in AI Modal */
        .ai-image-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 16px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-image-area:hover {
            background: #f3f4f6;
            border-color: #6366f1;
        }
        .ai-image-preview img {
            max-height: 180px;
            margin: 10px auto;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Přihlášení</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-gray-700 font-bold mb-2">Email</label>
                    <input type="email" id="admin-username" class="input-field" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-gray-700 font-bold mb-2">Heslo</label>
                    <input type="password" id="admin-password" class="input-field" required>
                </div>
                <div id="admin-login-error" class="text-red-500 text-center mb-4 hidden"></div>
                <button type="submit" class="btn btn-primary w-full">Přihlásit se</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="relative min-h-screen md:flex">
            <div class="md:hidden flex justify-between items-center bg-gray-800 text-white p-4">
                <h1 class="text-xl font-bold">HORIZON ESTATES</h1>
                <button id="mobile-menu-button" class="focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>

            <div id="sidebar" class="w-64 bg-gray-800 text-white p-5 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
                <h1 class="text-2xl font-bold mb-10 text-center hidden md:block">HORIZON ESTATES</h1>
                <nav class="flex-grow">
                    <a href="#" id="show-properties-btn" class="sidebar-link active"><i class="fas fa-list mr-2"></i>Správa nemovitostí</a></br>
                    <a href="#" id="show-tags-btn" class="sidebar-link"><i class="fas fa-tags mr-2"></i>Správa SEO tagů</a></br>
                    <a href="#" id="show-settings-btn" class="sidebar-link"><i class="fas fa-cog mr-2"></i>Nastavení</a></br>
                    <a href="#" id="show-pages-btn" class="sidebar-link"><i class="fas fa-file-alt mr-2"></i>Správa stránek</a>
                </nav>
                <button id="admin-logout-btn" class="btn btn-danger w-full mt-auto"><i class="fas fa-sign-out-alt mr-2"></i>Odhlásit se</button>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
                    <div id="firestore-error" class="error-message hidden mb-6"></div>

                    <!-- Notifikace o stahování -->
                    <div id="download-notification" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50">
                        <div class="flex items-center">
                            <i class="fas fa-spinner fa-spin mr-3"></i>
                            <div>
                                <h4 class="font-bold">Zpracovávám obrázky...</h4>
                                <p class="text-sm">Aplikuji vodoznak HORIZON-ESTATES.</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI MODAL WINDOW (UPRAVENO PRO FOTO) -->
                    <div id="ai-modal" class="ai-modal-overlay">
                        <div class="ai-modal-content">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-pink-500">
                                    <i class="fas fa-magic mr-2 text-indigo-500"></i>AI Asistent (Text & Foto)
                                </h3>
                                <button id="close-ai-modal" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">
                                Vložte text inzerátu nebo nahrajte/vložte (CTRL+V) obrázek inzerátu. Systém rozpozná cenu, plochu a lokalitu. <strong>Název a Popis nebudou vyplněny.</strong>
                            </p>
                            
                            <!-- Oblast pro vložení/nahrání obrázku -->
                            <div class="ai-image-area" id="ai-image-drop-area">
                                <p class="text-sm text-gray-500 font-medium"><i class="fas fa-camera mr-2"></i>Klikněte pro nahrání obrázku nebo sem vložte screenshot (CTRL+V)</p>
                                <input type="file" id="ai-image-input" accept="image/*" class="hidden">
                                <div id="ai-image-preview" class="ai-image-preview"></div>
                            </div>

                            <textarea id="ai-input-text" class="ai-textarea" placeholder="Zde vložte text nemovitosti... (volitelné, pokud nahráváte obrázek)"></textarea>
                            <div class="flex justify-end gap-3">
                                <button id="ai-process-btn" class="btn btn-ai w-full sm:w-auto">
                                    <i class="fas fa-robot mr-2"></i>Analyzovat a Vyplnit
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- END AI MODAL -->

                    <div id="property-list-view">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa nemovitostí</h2>
                            <button id="add-property-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat nemovitost</button>
                        </header>

                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex -mb-px" id="property-country-tabs">
                                <button type="button" data-country="bulharsko" class="tab-button active" style="padding: 10px;">Bulharsko</button>
                                <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                            </nav>
                        </div>
                        
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Č. nabídky</th>
                                        <th class="table-header">Foto</th>
                                        <th class="table-header">Název (CZ)</th>
                                        <th class="table-header">Cena</th>
                                        <th class="table-header">Datum vydání</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="properties-table-body" style="text-align: center;">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="property-form-view" class="hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 id="form-title" class="text-3xl font-semibold text-gray-700">Přidat novou nemovitost</h2>
                            
                            <!-- TLAČÍTKO AI GENERÁTOR -->
                            <button type="button" id="open-ai-modal-btn" class="btn btn-ai">
                                <i class="fas fa-sparkles mr-2"></i>AI Generátor
                            </button>
                        </div>

                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="property-form">
                                <input type="hidden" id="property-id">
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="property-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding: 5px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding: 5px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button" style="padding: 5px;">Němčina</button>
                                    </nav>
                                </div>

                                <div id="property-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="property-title-cz" class="block text-gray-700 font-bold mb-2">Název nemovitosti (CZ)</label>
                                        <input type="text" id="property-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-description-cz" class="block text-gray-700 font-bold mb-2">Popis (CZ)</label>
                                        <textarea id="property-description-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="property-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-en" class="block text-gray-700 font-bold mb-2">Název nemovitosti (EN)</label>
                                        <input type="text" id="property-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-en" class="block text-gray-700 font-bold mb-2">Popis (EN)</label>
                                        <textarea id="property-description-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="property-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="property-title-de" class="block text-gray-700 font-bold mb-2">Název nemovitosti (DE)</label>
                                        <input type="text" id="property-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-description-de" class="block text-gray-700 font-bold mb-2">Popis (DE)</label>
                                        <textarea id="property-description-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>

                                <hr class="my-6">

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label for="property-price" class="block text-gray-700 font-bold mb-2">Cena (€)</label>
                                        <input type="number" id="property-price" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-id" class="block text-gray-700 font-bold mb-2">Číslo nabídky</label>
                                        <input type="number" id="property-offer-id" class="input-field" placeholder="Zadejte číslo" required>
                                    </div>
                                    <div>
                                        <label for="property-offer-type" class="block text-gray-700 font-bold mb-2">Typ nabídky</label>
                                        <select id="property-offer-type" class="input-field" required>
                                            <option value="prodej">Prodej</option>
                                            <option value="pronajem">Pronájem</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-country" class="block text-gray-700 font-bold mb-2">Země</label>
                                        <select id="property-country" class="input-field" required>
                                            <option value="">-- Vyberte zemi --</option>
                                            <option value="bulharsko">Bulharsko</option>
                                            <option value="spanelsko">Španělsko</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="property-location" class="block text-gray-700 font-bold mb-2">Lokalita</label>
                                        <select id="property-location" class="input-field" required></select>
                                    </div>
                                     <div>
                                        <label for="property-type" class="block text-gray-700 font-bold mb-2">Druh nemovitosti</label>
                                        <select id="property-type" class="input-field" required></select>
                                    </div>
                                    <div>
                                        <label for="property-rooms" class="block text-gray-700 font-bold mb-2">Dispozice</label>
                                        <select id="property-rooms" class="input-field"></select>
                                    </div>
                                     <div>
                                        <label for="property-floor" class="block text-gray-700 font-bold mb-2">Podlaží</label>
                                        <input type="number" id="property-floor" class="input-field">
                                    </div>
                                    <div>
                                        <label for="property-area" class="block text-gray-700 font-bold mb-2">Plocha (m²)</label>
                                        <input type="number" id="property-area" class="input-field">
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="property-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="property-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Další Vlastnosti</h3>
                                    <p class="text-sm text-gray-500 mb-4">Pořadí vlastností lze změnit v sekci "Nastavení".</p>
                                    <div id="features-container" class="feature-grid pt-4"></div>
                                </div>
                                
                                <!-- DRAG AND DROP SEKCE PRO FOTOGRAFIE -->
                                <div class="mt-6">
                                    <label class="block text-gray-700 font-bold mb-2">Fotografie</label>
                                    
                                    <!-- Drop Zóna -->
                                    <div id="drop-zone" class="drop-zone-container">
                                        <div class="upload-controls">
                                            <button type="button" class="btn-upload" id="btn-browse-images">Zvolit soubory</button>
                                            <div id="drop-status-text" class="text-gray-500 text-sm">Soubor nevybrán</div>
                                        </div>
                                        <span class="drag-hint">Tip: Soubory můžete do tohoto rámečku přímo přetáhnout myší.</span>
                                        
                                        <!-- Skrytý input -->
                                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
                                    </div>

                                    <!-- Kontejner pro náhledy obrázků -->
                                    <div id="image-preview-container" class="image-preview-container"></div>
                                    
                                    <!-- Progress bar pro nahrávání -->
                                    <div id="upload-progress" class="hidden mt-4">
                                        <p id="upload-status" class="font-semibold">Nahrávám obrázky...</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit nemovitost</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="page-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa stránek</h2>
                            <button id="add-page-btn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Přidat stránku</button>
                        </header>
                        <div class="bg-white shadow-md rounded overflow-x-auto">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th class="table-header">Název stránky (CZ)</th>
                                        <th class="table-header">URL (slug)</th>
                                        <th class="table-header">Stav</th>
                                        <th class="table-header">Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="pages-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="page-form-view" class="hidden">
                        <h2 id="page-form-title" class="text-3xl font-semibold text-gray-700 mb-6">Přidat novou stránku</h2>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <form id="page-form">
                                <input type="hidden" id="page-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="page-slug" class="block text-gray-700 font-bold mb-2">URL Slug (bez diakritiky, např. 'o-nas')</label>
                                        <input type="text" id="page-slug" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-status" class="block text-gray-700 font-bold mb-2">Stav</label>
                                        <select id="page-status" class="input-field" required>
                                            <option value="Aktivní">Aktivní</option>
                                            <option value="Neaktivní">Neaktivní</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-4 border-b border-gray-200">
                                    <nav class="flex -mb-px" id="page-lang-tabs">
                                        <button type="button" data-lang="cz" class="tab-button active" style="padding-right: 8px;">Čeština</button>
                                        <button type="button" data-lang="en" class="tab-button" style="padding-right: 8px;">Angličtina</button>
                                        <button type="button" data-lang="de" class="tab-button">Němčina</button>
                                    </nav>
                                </div>
                                <div id="page-lang-cz" class="lang-tab-content active space-y-6">
                                    <div>
                                        <label for="page-title-cz" class="block text-gray-700 font-bold mb-2">Název stránky (CZ)</label>
                                        <input type="text" id="page-title-cz" class="input-field" required>
                                    </div>
                                    <div>
                                        <label for="page-content-cz" class="block text-gray-700 font-bold mb-2">Obsah stránky (CZ)</label>
                                        <textarea id="page-content-cz" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-en" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-en" class="block text-gray-700 font-bold mb-2">Název stránky (EN)</label>
                                        <input type="text" id="page-title-en" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-en" class="block text-gray-700 font-bold mb-2">Obsah stránky (EN)</label>
                                        <textarea id="page-content-en" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div id="page-lang-de" class="lang-tab-content space-y-6">
                                    <div>
                                        <label for="page-title-de" class="block text-gray-700 font-bold mb-2">Název stránky (DE)</label>
                                        <input type="text" id="page-title-de" class="input-field">
                                    </div>
                                    <div>
                                        <label for="page-content-de" class="block text-gray-700 font-bold mb-2">Obsah stránky (DE)</label>
                                        <textarea id="page-content-de" class="tinymce-editor"></textarea>
                                    </div>
                                </div>
                                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                                    <button type="button" id="cancel-page-form-btn" class="btn btn-secondary">Zrušit</button>
                                    <button type="submit" class="btn btn-primary">Uložit stránku</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="tag-management-view" class="hidden">
                        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700">Správa SEO tagů</h2>
                        </header>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Seznam tagů</h3>
                            <div id="tags-list" class="mb-4"></div>
                            <form id="form-tags" class="flex gap-2 items-start">
                                <div class="flex-grow">
                                    <input type="text" id="new-tag-input" placeholder="Přidat nebo upravit tag" class="input-field">
                                </div>
                                <button id="add-tag-btn" type="submit" class="btn btn-primary whitespace-nowrap">Přidat</button>
                                <button id="cancel-edit-tag-btn" type="button" class="btn btn-secondary whitespace-nowrap hidden">Zrušit</button>
                            </form>
                            <p class="text-sm text-gray-500 mt-4">Tyto tagy se automaticky přidají jako klíčová slova do hlavičky všech stránek pro zlepšení SEO.</p>
                        </div>
                    </div>

                    <div id="settings-view" class="hidden">
                         <h2 class="text-2xl sm:text-3xl font-semibold text-gray-700 mb-6">Nastavení</h2>
                         
                         <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                             <h3 class="text-xl font-bold mb-4">Globální nastavení</h3>
                             <form id="global-settings-form">
                                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 1</h4>
                                                <label for="setting-contact1-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                                <input type="text" id="setting-contact1-name" class="input-field mb-4">
                                                <label for="setting-contact1-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                                <input type="text" id="setting-contact1-phone" class="input-field mb-4">
                                                <label for="setting-contact1-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                                <input type="text" id="setting-contact1-phone2" class="input-field mb-4">
                                                <label for="setting-contact1-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                                <input type="text" id="setting-contact1-email" class="input-field">
                                            </div>
                                             <div>
                                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Kontakt 2</h4>
                                                <label for="setting-contact2-name" class="block text-gray-700 font-bold mb-2">Jméno</label>
                                                <input type="text" id="setting-contact2-name" class="input-field mb-4">
                                                <label for="setting-contact2-phone" class="block text-gray-700 font-bold mb-2">Telefon 1</label>
                                                <input type="text" id="setting-contact2-phone" class="input-field mb-4">
                                                <label for="setting-contact2-phone2" class="block text-gray-700 font-bold mb-2">Telefon 2</label>
                                                <input type="text" id="setting-contact2-phone2" class="input-field mb-4">
                                                <label for="setting-contact2-email" class="block text-gray-700 font-bold mb-2">Email</label>
                                                <input type="text" id="setting-contact2-email" class="input-field">
                                            </div>
                                   </div>
                                <div class="mt-6 flex justify-end">
                                    <button type="submit" class="btn btn-primary">Uložit globální kontakty</button>
                                </div>
                             </form>
                             <hr class="my-6">
                             <h3 class="text-xl font-bold mb-4">Správa Vlastností (globální)</h3>
                             <p class="text-sm text-gray-500 mb-4">Zde můžete spravovat globální vlastnosti, které se nabízejí u všech nemovitostí. Pořadí zatím nelze měnit.</p>
                             <div id="features-list" class="mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                             <form id="form-features" class="space-y-4 p-4 border rounded-md">
                                   <h4 id="features-form-title" class="font-bold text-lg">Přidat novou vlastnost</h4>
                                   <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label for="new-features-cz-input" class="block text-sm font-medium text-gray-700">Název CZ</label>
                                                <input type="text" id="new-features-cz-input" class="input-field mt-1" required>
                                            </div>
                                            <div>
                                                <label for="new-features-en-input" class="block text-sm font-medium text-gray-700">Název EN</label>
                                                <input type="text" id="new-features-en-input" class="input-field mt-1">
                                            </div>
                                            <div>
                                                <label for="new-features-de-input" class="block text-sm font-medium text-gray-700">Název DE</label>
                                                <input type="text" id="new-features-de-input" class="input-field mt-1">
                                            </div>
                                   </div>
                                   <div class="flex gap-2 mt-4">
                                        <button type="submit" class="btn btn-primary w-full md:w-auto">Přidat</button>
                                        <button type="button" class="btn btn-secondary hidden cancel-edit-btn">Zrušit úpravu</button>
                                   </div>
                             </form>
                          </div>

                        <div class="mb-4 border-b border-gray-200">
                             <nav class="flex -mb-px" id="settings-tabs">
                                 <button type="button" data-country="bulharsko" class="tab-button active" style="padding-right: 15px;">Bulharsko</button>
                                 <button type="button" data-country="spanelsko" class="tab-button">Španělsko</button>
                             </nav>
                        </div>

                        <div id="country-specific-settings-container">
                            </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <script type="module">
        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
            query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAi_ugQSDUjk4y8ne4zpAyTbzNrf96SWDc",
            authDomain: "login-40bf8.firebaseapp.com",
            projectId: "login-40bf8",
            storageBucket: "gs://login-40bf8.firebasestorage.app", // Corrected storage bucket URL
            messagingSenderId: "932200625165",
            appId: "1:932200625165:web:422564c4f9c3f9fbead144"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Initialize TinyMCE ---
        const initTinyMCE = (selector) => {
            tinymce.init({
                selector: selector,
                entity_encoding: 'raw',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
                height: 300,
            });
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            initTinyMCE('.tinymce-editor');
        });

        // --- Global state variables ---
        let filesToUpload = [];
        let existingImageUrls = [];
        let currentSettingsCountry = 'bulharsko';
        let currentPropertyListCountry = 'bulharsko';
        let currentEditItem = { type: null, key: null };
        let currentEditTag = null; // For editing SEO tags

        // --- UI Element Selectors ---
        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        
        // Views
        const allViews = {
            propertyList: document.getElementById('property-list-view'),
            propertyForm: document.getElementById('property-form-view'),
            pageManagement: document.getElementById('page-management-view'),
            pageForm: document.getElementById('page-form-view'),
            tagManagement: document.getElementById('tag-management-view'),
            settings: document.getElementById('settings-view')
        };

        // Sidebar Buttons
        const sidebarButtons = {
            properties: document.getElementById('show-properties-btn'),
            pages: document.getElementById('show-pages-btn'),
            tags: document.getElementById('show-tags-btn'),
            settings: document.getElementById('show-settings-btn')
        };
        
        // --- Mobile Menu Toggle ---
        mobileMenuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // --- AI GENERÁTOR LOGIKA (NOVÉ s OCR a vložením obrázku) ---
        const aiModal = document.getElementById('ai-modal');
        const openAiModalBtn = document.getElementById('open-ai-modal-btn');
        const closeAiModalBtn = document.getElementById('close-ai-modal');
        const aiProcessBtn = document.getElementById('ai-process-btn');
        const aiInputText = document.getElementById('ai-input-text');
        
        // Nové prvky pro obrázek v AI modalu
        const aiImageInput = document.getElementById('ai-image-input');
        const aiImageDropArea = document.getElementById('ai-image-drop-area');
        const aiImagePreview = document.getElementById('ai-image-preview');
        let aiImageFile = null;

        openAiModalBtn.addEventListener('click', () => {
            aiModal.classList.add('active');
            aiInputText.focus();
            // Reset formuláře AI
            aiInputText.value = '';
            aiImageFile = null;
            aiImagePreview.innerHTML = '';
            aiImageInput.value = '';
        });

        closeAiModalBtn.addEventListener('click', () => {
            aiModal.classList.remove('active');
        });

        // Zavření modalu kliknutím mimo obsah
        aiModal.addEventListener('click', (e) => {
            if (e.target === aiModal) {
                aiModal.classList.remove('active');
            }
        });

        // --- LOGIKA PRO OBRÁZKY V AI MODALU ---
        // Klik na drop area otevře dialog
        aiImageDropArea.addEventListener('click', (e) => {
            if(e.target !== aiImageInput) {
                aiImageInput.click();
            }
        });

        // Změna inputu (výběr souboru)
        aiImageInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleAiImage(e.target.files[0]);
            }
        });

        // PASTE (Vložení) obrázku ze schránky (CTRL+V)
        window.addEventListener('paste', (e) => {
            if (!aiModal.classList.contains('active')) return;

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    handleAiImage(blob);
                }
            }
        });

        function handleAiImage(file) {
            aiImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                aiImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            }
            reader.readAsDataURL(file);
        }

        // HLAVNÍ FUNKCE PRO ANALÝZU TEXTU a OCR
        aiProcessBtn.addEventListener('click', async () => {
            const rawText = aiInputText.value.trim();
            
            if (!rawText && !aiImageFile) {
                alert('Prosím vložte text inzerátu nebo nahrajte obrázek.');
                return;
            }
            
            const originalBtnText = aiProcessBtn.innerHTML;
            aiProcessBtn.disabled = true;

            try {
                let textToAnalyze = rawText;

                // 1. Pokud je obrázek, provedeme OCR
                if (aiImageFile) {
                    aiProcessBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>Čtu text z obrázku...';
                    
                    // Použití Tesseract.js pro OCR
                    const worker = await Tesseract.createWorker('ces'); // čeština
                    const ret = await worker.recognize(aiImageFile);
                    await worker.terminate();
                    
                    console.log("OCR Result:", ret.data.text);
                    textToAnalyze += "\n" + ret.data.text;
                }

                aiProcessBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzuji data...';
                await new Promise(resolve => setTimeout(resolve, 500)); // Krátká prodleva
                
                analyzeAndFillForm(textToAnalyze);
                
                aiModal.classList.remove('active');
                alert('Formulář byl automaticky vyplněn! (Název a Popis zůstaly prázdné dle požadavku). Zkontrolujte prosím údaje.');

            } catch (error) {
                console.error("Chyba při AI analýze:", error);
                alert("Nepodařilo se analyzovat data (OCR chyba nebo jiný problém).");
            } finally {
                aiProcessBtn.innerHTML = originalBtnText;
                aiProcessBtn.disabled = false;
            }
        });

        function analyzeAndFillForm(text) {
            // POZNÁMKA: Název a Popis jsou záměrně vynechány z vyplňování

            // 1. CENA (Hledá čísla následovaná €, eur, EUR atd.)
            const priceRegex = /(\d[\d\s.,]*)\s*(?:€|Eur|eur|EUR)/;
            const priceMatch = text.match(priceRegex);
            if (priceMatch) {
                const cleanPrice = priceMatch[1].replace(/[\s,.]/g, '');
                if (!isNaN(cleanPrice)) {
                    document.getElementById('property-price').value = cleanPrice;
                }
            }

            // 2. PLOCHA (Hledá m2, m², metrů)
            const areaRegex = /(\d[\d\s.,]*)\s*(?:m2|m²|metrů|sqm)/i;
            const areaMatch = text.match(areaRegex);
            if (areaMatch) {
                const cleanArea = areaMatch[1].replace(/[\s,.]/g, '');
                if (!isNaN(cleanArea)) {
                    document.getElementById('property-area').value = cleanArea;
                }
            }

            // 3. PODLAŽÍ (Hledá "x. patro", "x. NP")
            const floorRegex = /(\d+)\.?\s*(?:patro|np|podlaží)/i;
            const floorMatch = text.match(floorRegex);
            if (floorMatch) {
                document.getElementById('property-floor').value = floorMatch[1];
            }

            // 4. DISPOZICE (Pokus o matchnutí s select boxem)
            const roomsSelect = document.getElementById('property-rooms');
            const roomsTextLower = text.toLowerCase();
            for (let i = 0; i < roomsSelect.options.length; i++) {
                const optText = roomsSelect.options[i].text.toLowerCase();
                if (optText && roomsTextLower.includes(optText)) {
                    roomsSelect.selectedIndex = i;
                    break; 
                }
            }
            // Fallback pokud se nenajde přesná shoda
            if (roomsSelect.value === "") {
                 if (roomsTextLower.includes("studio") || roomsTextLower.includes("garson")) {
                      for (let i=0; i<roomsSelect.options.length; i++) {
                          if (roomsSelect.options[i].text.toLowerCase().includes("studio")) {
                             roomsSelect.selectedIndex = i; break;
                          }
                      }
                 }
            }

            // 5. LOKALITA (Porovnává s načtenými lokalitami)
            const locationSelect = document.getElementById('property-location');
            for (let i = 0; i < locationSelect.options.length; i++) {
                const locName = locationSelect.options[i].text;
                if (locName && text.includes(locName)) {
                    locationSelect.selectedIndex = i;
                    break;
                }
            }

            // 6. DRUH NEMOVITOSTI
            const typeSelect = document.getElementById('property-type');
            const typeTextLower = text.toLowerCase();
            for (let i = 0; i < typeSelect.options.length; i++) {
                const typeName = typeSelect.options[i].text.toLowerCase();
                if (typeName && typeTextLower.includes(typeName.slice(0, -1))) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }

            // 7. CHECKBOXY VLASTNOSTÍ
            const featureCheckboxes = document.querySelectorAll('#features-container input[type="checkbox"]');
            const lowerText = text.toLowerCase();
            featureCheckboxes.forEach(cb => {
                const label = cb.nextElementSibling.textContent.toLowerCase();
                if (lowerText.includes(label)) {
                    cb.checked = true;
                }
            });
        }
        // --- KONEC AI GENERÁTOR LOGIKY ---


        // --- Helper Functions ---
        function slugify(text) {
            if (typeof text !== 'string') return '';
            const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
            const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
            const p = new RegExp(a.split('').join('|'), 'g')

            return text.toString().toLowerCase()
                .replace(/\s+/g, '-') 
                .replace(p, c => b.charAt(a.indexOf(c))) 
                .replace(/&/g, '-and-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, '') 
        }
        
        function handleFirestoreError(error, context = "Neznámá operace") {
            console.error(`Firestore Error during ${context}:`, error);
            const firestoreError = document.getElementById('firestore-error');
            firestoreError.innerHTML = `<strong>Chyba databáze (${context}):</strong> ${error.message}. Zkontrolujte konzoli pro více detailů.`;
            firestoreError.classList.remove('hidden');
        }

        function setEditorContent(editorId, content) {
             const editor = tinymce.get(editorId);
             if (editor) {
                 editor.setContent(content || '');
             } else {
                 console.warn(`Editor with ID ${editorId} not found.`);
             }
        }

        function getEditorContent(editorId) {
            const editor = tinymce.get(editorId);
            return editor ? editor.getContent() : '';
        }

        function renderList(type, items, formId) {
            const container = document.getElementById(`${type}-list`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const sortedItems = (items || []).sort((a, b) => {
                const nameA = (typeof a === 'object' ? a.name_cz : a) || '';
                const nameB = (typeof b === 'object' ? b.name_cz : b) || '';
                return nameA.localeCompare(nameB, 'cs');
            });

            sortedItems.forEach(item => {
                const isObject = typeof item === 'object' && item !== null;
                const key = isObject ? item.key : slugify(item);
                const name_cz = isObject ? item.name_cz : item;
                const name_en = isObject ? item.name_en || '-' : '-';
                const name_de = isObject ? item.name_de || '-' : '-';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded text-sm';
                itemDiv.innerHTML = `
                    <div class="flex-grow mr-4">
                        <strong class="text-gray-800">${name_cz || '(Chybí český název)'}</strong>
                        ${(type !== 'locations') ? `<div class="text-gray-500"><span class="mr-3">EN: ${name_en}</span><span>DE: ${name_de}</span></div>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex items-center">
                        <button class="edit-setting-item-btn text-blue-600 hover:text-blue-900 mr-3" data-type="${type}" data-key="${key}" data-form-id="${formId}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-setting-item-btn text-red-500 hover:text-red-700" data-type="${type}" data-key="${key}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function renderMenuItems(menuType, items) {
            const container = document.getElementById(`${menuType}-menu-list-${currentSettingsCountry}`);
            if (!container) return;
            container.innerHTML = '';
            (items || []).forEach(item => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                        <span>${item.title} -> /${item.slug}</span>
                        <button class="delete-menu-item-btn text-red-500 hover:text-red-700" data-menu-type="${menuType}" data-title="${item.title}" data-slug="${item.slug}">&times;</button>
                    </div>`;
            });
        }

        // --- App View Management ---
        function showView(viewName, buttonName) {
            Object.values(allViews).forEach(v => v.classList.add('hidden'));
            Object.values(sidebarButtons).forEach(b => b.classList.remove('active'));
            
            if (allViews[viewName]) allViews[viewName].classList.remove('hidden');
            if (sidebarButtons[buttonName]) sidebarButtons[buttonName].classList.add('active');
            
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in. The login function will handle the rest.
            } else {
                dashboard.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            adminLoginError.classList.add('hidden');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    showView('propertyList', 'properties');
                    loadProperties(currentPropertyListCountry);
                } else {
                    adminLoginError.textContent = "Přístup odepřen. Tento účet nemá oprávnění administrátora.";
                    adminLoginError.classList.remove('hidden');
                    await signOut(auth);
                }

            } catch (error) {
                console.error("Chyba přihlášení:", error.code, error.message);
                adminLoginError.textContent = "Nesprávný email nebo heslo. Zkontrolujte prosím své přihlašovací údaje a zkuste to znovu.";
                adminLoginError.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', () => signOut(auth));

        // --- Sidebar Navigation ---
        sidebarButtons.properties.addEventListener('click', () => {
            showView('propertyList', 'properties');
            loadProperties(currentPropertyListCountry);
        });

        sidebarButtons.pages.addEventListener('click', () => {
            showView('pageManagement', 'pages');
            loadPages();
        });

        sidebarButtons.tags.addEventListener('click', () => {
            showView('tagManagement', 'tags');
            loadTags();
        });

        sidebarButtons.settings.addEventListener('click', () => {
            showView('settings', 'settings');
            loadGlobalSettings();
            loadAndRenderCountrySettings();
        });

        // --- Property Management ---
        const propertyForm = document.getElementById('property-form');
        const propertiesTableBody = document.getElementById('properties-table-body');
        const propertyCountryTabs = document.getElementById('property-country-tabs');
        
        propertyCountryTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPropertyListCountry = e.target.dataset.country;
                propertyCountryTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadProperties(currentPropertyListCountry);
            }
        });
        
        async function loadProperties(country) {
            try {
                const propertiesRef = collection(db, 'properties');
                const q = query(propertiesRef, where('country', '==', country));
                const querySnapshot = await getDocs(q);
                
                let properties = [];
                querySnapshot.forEach(doc => {
                    properties.push({ id: doc.id, ...doc.data() });
                });

                // Sort manually to avoid composite indexes
                properties.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                propertiesTableBody.innerHTML = '';
                if (properties.length === 0) {
                    propertiesTableBody.innerHTML = '<tr><td colspan="7" class="table-cell text-center">Nebyly nalezeny žádné nemovitosti.</td></tr>';
                    return;
                }
                properties.forEach(prop => {
                    const firstImage = prop.images && prop.images.length > 0 ? prop.images[0] : 'https://placehold.co/100x60/eee/ccc?text=Foto';
                    const createdAt = prop.createdAt ? prop.createdAt.toDate().toLocaleDateString('cs-CZ') : 'N/A';
                    const statusClass = prop.status === 'Aktivní' ? 'active' : 'inactive';
                    
                    const row = `
                        <tr id="${prop.id}">
                            <td class="table-cell font-mono">${prop.offerId || 'N/A'}</td>
                            <td class="table-cell"><img src="${firstImage}" alt="Foto nemovitosti" class="w-24 h-16 object-cover rounded mx-auto"></td>
                            <td class="table-cell">
                                <p class="text-gray-900 whitespace-no-wrap font-bold">${prop.title_cz || prop.title}</p>
                                <p class="text-gray-600 whitespace-no-wrap">${prop.location}, ${prop.country}</p>
                            </td>
                            <td class="table-cell text-red-600 font-bold">€${Number(prop.price).toLocaleString('de-DE')}</td>
                            <td class="table-cell">${createdAt}</td>
                            <td class="table-cell">
                                <span class="status-toggle ${statusClass}" data-id="${prop.id}">${prop.status || 'Neaktivní'}</span>
                            </td>
                            <td class="table-cell">
                                <div class="flex justify-center space-x-2">
                                    <button class="download-property-btn text-green-600 hover:text-green-800" title="Stáhnout fotky s vodoznakem" data-id="${prop.id}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="edit-property-btn text-blue-600 hover:text-blue-900" data-id="${prop.id}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-property-btn text-red-600 hover:text-red-900" data-id="${prop.id}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    propertiesTableBody.innerHTML += row;
                });
            } catch (error) {
                handleFirestoreError(error, 'Načítání nemovitostí');
            }
        }

        function resetPropertyForm() {
            propertyForm.reset();
            document.getElementById('property-id').value = '';
            document.getElementById('form-title').textContent = 'Přidat novou nemovitost';
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('property-offer-id').readOnly = false;
            ['cz', 'en', 'de'].forEach(lang => {
                setEditorContent(`property-description-${lang}`, '');
            });
            filesToUpload = [];
            existingImageUrls = [];
            document.getElementById('upload-progress').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('drop-status-text').textContent = "Soubor nevybrán";
        }
        
        async function openNewPropertyForm() {
            resetPropertyForm();
            await populateFormDropdowns('bulharsko');
            await populateFeatures([]);
            showView('propertyForm', 'properties');
        }
        
        document.getElementById('add-property-btn').addEventListener('click', openNewPropertyForm);
        document.getElementById('cancel-form-btn').addEventListener('click', () => showView('propertyList', 'properties'));
        document.getElementById('property-country').addEventListener('change', async (e) => await populateFormDropdowns(e.target.value));

        propertyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Ukládám...';

            try {
                const newImageUrls = await uploadImages(filesToUpload);
                const allImageUrls = [...existingImageUrls, ...newImageUrls];

                const selectedFeatures = Array.from(document.querySelectorAll('#features-container input:checked')).map(cb => cb.value);

                const propertyData = {
                    title_cz: document.getElementById('property-title-cz').value,
                    description_cz: getEditorContent('property-description-cz'),
                    title_en: document.getElementById('property-title-en').value,
                    description_en: getEditorContent('property-description-en'),
                    title_de: document.getElementById('property-title-de').value,
                    description_de: getEditorContent('property-description-de'),
                    price: Number(document.getElementById('property-price').value),
                    offerId: Number(document.getElementById('property-offer-id').value),
                    offerType: document.getElementById('property-offer-type').value,
                    country: document.getElementById('property-country').value,
                    location: document.getElementById('property-location').value,
                    type: document.getElementById('property-type').value,
                    rooms: document.getElementById('property-rooms').value,
                    floor: Number(document.getElementById('property-floor').value) || null,
                    area: Number(document.getElementById('property-area').value) || null,
                    images: allImageUrls,
                    features: selectedFeatures,
                    status: document.getElementById('property-status').value,
                    lastUpdated: serverTimestamp()
                };

                const id = document.getElementById('property-id').value;
                if (id) {
                    await updateDoc(doc(db, 'properties', id), propertyData);
                } else {
                    propertyData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'properties'), propertyData);
                }
                
                showView('propertyList', 'properties');
                loadProperties(currentPropertyListCountry);
            } catch (error) {
                handleFirestoreError(error, 'Ukládání nemovitosti');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Uložit nemovitost';
            }
        });

        // --- WATERMARK LOGIC (CENTERED, BIG, TRANSPARENT) ---
        function applyWatermarkToCanvas(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;

            // 1. Kreslíme původní obrázek
            ctx.drawImage(img, 0, 0);

            // 2. Nastavení textu vodoznaku
            const text = "HORIZON-ESTATES";
            
            // Font size: cca 80% šířky obrázku (aby byl VELKÝ)
            const fontSize = canvas.width * 0.08; 
            
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            ctx.textAlign = 'center'; // Zarovnání na střed
            ctx.textBaseline = 'middle'; // Vertikální zarovnání na střed

            // 3. Stín (pro čitelnost na světlém pozadí)
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)"; // Černý poloprůhledný stín
            ctx.shadowBlur = fontSize / 5;
            ctx.shadowOffsetX = fontSize / 20;
            ctx.shadowOffsetY = fontSize / 20;

            // 4. Barva textu (BÍLÁ POLOPRŮHLEDNÁ)
            ctx.fillStyle = "rgba(255, 255, 255, 0.75)"; 
            
            // 5. Vykreslení textu PŘESNĚ DOPROSTŘED
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            return canvas;
        }

        async function downloadPropertyImagesWithWatermark(propertyId) {
            const notification = document.getElementById('download-notification');
            try {
                // Zobrazit notifikaci
                notification.classList.remove('hidden');

                // Získání dat
                const docRef = doc(db, 'properties', propertyId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) throw new Error("Nemovitost nenalezena");
                
                const data = docSnap.data();
                const images = data.images || [];
                const offerId = data.offerId || propertyId;

                if (images.length === 0) {
                    alert("Tato nemovitost nemá žádné fotografie.");
                    return;
                }

                // ZIP archiv
                const zip = new JSZip();
                const folder = zip.folder(`nabidka_${offerId}`);

                // Zpracování obrázků
                const imagePromises = images.map(async (url, index) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; // Nutné pro Canvas
                        
                        img.onload = () => {
                            try {
                                const canvas = applyWatermarkToCanvas(img);
                                
                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        folder.file(`image_${index + 1}.jpg`, blob);
                                        resolve();
                                    } else {
                                        reject("Chyba při konverzi canvasu");
                                    }
                                }, 'image/jpeg', 0.9); // Kvalita 90%
                            } catch (err) {
                                console.error("Chyba při kreslení vodoznaku (CORS?):", err);
                                resolve(); // Pokračujeme i s chybou
                            }
                        };

                        img.onerror = (e) => {
                            console.error("Nepodařilo se načíst obrázek:", url);
                            resolve(); 
                        };

                        img.src = url;
                    });
                });

                await Promise.all(imagePromises);

                // Generování a stažení ZIPu
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `Horizon_Estates_${offerId}.zip`);

            } catch (error) {
                console.error("Chyba při stahování:", error);
                alert("Nastala chyba při zpracování obrázků. Zkontrolujte konzoli.");
            } finally {
                notification.classList.add('hidden');
            }
        }

        propertiesTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button, span');
            if (!button) return;
            const id = button.dataset.id;
            
            if (button.classList.contains('download-property-btn')) {
                e.preventDefault(); 
                await downloadPropertyImagesWithWatermark(id);
                return;
            }

            if (button.classList.contains('status-toggle')) {
                const currentStatus = button.textContent;
                const newStatus = currentStatus === 'Aktivní' ? 'Neaktivní' : 'Aktivní';
                try {
                    await updateDoc(doc(db, 'properties', id), { status: newStatus });
                    loadProperties(currentPropertyListCountry);
                } catch (error) {
                    handleFirestoreError(error, 'Změna stavu nemovitosti');
                }
            }

            if (button.classList.contains('delete-property-btn')) {
                if (confirm('Opravdu chcete smazat tuto nemovitost? Tato akce je nevratná a smaže i všechny fotografie.')) {
                    try {
                        const propertyRef = doc(db, 'properties', id);
                        const docSnap = await getDoc(propertyRef);
                        
                        if (docSnap.exists()) {
                            const propertyData = docSnap.data();
                            if (propertyData.images && propertyData.images.length > 0) {
                                const deletePromises = propertyData.images.map(imageUrl => {
                                    try {
                                        const imageRef = ref(storage, imageUrl);
                                        return deleteObject(imageRef);
                                    } catch (err) {
                                        console.warn("Could not delete file:", imageUrl, err);
                                        return Promise.resolve();
                                    }
                                });
                                await Promise.all(deletePromises);
                            }
                        }
                        await deleteDoc(propertyRef);
                        document.getElementById(id).remove();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání nemovitosti');
                    }
                }
            }
            
            if (button.classList.contains('edit-property-btn')) {
                try {
                    const docRef = doc(db, 'properties', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const prop = docSnap.data();
                        
                        resetPropertyForm();
                        
                        document.getElementById('property-id').value = docSnap.id;
                        document.getElementById('form-title').textContent = 'Upravit nemovitost';
                        
                        document.getElementById('property-title-cz').value = prop.title_cz || prop.title || '';
                        document.getElementById('property-title-en').value = prop.title_en || '';
                        document.getElementById('property-title-de').value = prop.title_de || '';
                        setEditorContent('property-description-cz', prop.description_cz || prop.description || '');
                        setEditorContent('property-description-en', prop.description_en || '');
                        setEditorContent('property-description-de', prop.description_de || '');

                        document.getElementById('property-price').value = prop.price;
                        document.getElementById('property-offer-id').value = prop.offerId;
                        document.getElementById('property-offer-type').value = prop.offerType || 'prodej';
                        document.getElementById('property-country').value = prop.country;
                        document.getElementById('property-floor').value = prop.floor;
                        document.getElementById('property-area').value = prop.area;
                        document.getElementById('property-status').value = prop.status || 'Aktivní';
                        existingImageUrls = prop.images || [];
                        
                        await populateFormDropdowns(prop.country, prop);
                        await populateFeatures(prop.features || []);
                        
                        showView('propertyForm', 'properties');
                        previewImages();
                    }
                } catch (error) {
                    handleFirestoreError(error, 'Editace nemovitosti');
                }
            }
        });

        // --- Image Handling (DRAG & DROP UPDATED) ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('image-upload');
        const browseBtn = document.getElementById('btn-browse-images');
        const dropStatusText = document.getElementById('drop-status-text');

        // 1. Tlačítko
        browseBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Klik na box
        dropZone.addEventListener('click', (e) => {
            if (e.target !== browseBtn) {
                fileInput.click();
            }
        });

        // 2. Input change
        fileInput.addEventListener('change', (e) => {
            filesToUpload.push(...e.target.files);
            updateStatusText();
            previewImages();
            fileInput.value = ''; 
        });

        // 3. Drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });

        // Drop handler
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                filesToUpload.push(...files);
                updateStatusText();
                previewImages();
            }
        });
        
        function updateStatusText() {
             if (filesToUpload.length > 0) {
                 dropStatusText.textContent = `Připraveno k nahrání: ${filesToUpload.length} nových fotografií`;
             } else {
                 dropStatusText.textContent = "Soubor nevybrán";
             }
        }

        function previewImages() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            const allImages = [
                ...existingImageUrls.map((url, index) => ({ type: 'existing', data: url, index })),
                ...filesToUpload.map((file, index) => ({ type: 'new', data: file, index }))
            ];

            allImages.forEach(img => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                const imgTag = document.createElement('img');
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.dataset.type = img.type;
                removeBtn.dataset.index = img.index;
                item.append(imgTag, removeBtn);
                container.appendChild(item);
                imgTag.src = (img.type === 'existing') ? img.data : URL.createObjectURL(img.data);
            });
        }
        
        document.getElementById('image-preview-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-image-btn')) {
                const type = e.target.dataset.type;
                const index = parseInt(e.target.dataset.index, 10);
                if (type === 'new') filesToUpload.splice(index, 1);
                else if (type === 'existing') existingImageUrls.splice(index, 1);
                updateStatusText();
                previewImages();
            }
        });

        async function uploadImages(files) {
            if (files.length === 0) return [];
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('upload-status');
            progressContainer.classList.remove('hidden');
            const imageUrls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = `${Date.now()}-${file.name}`;
                const storageRef = ref(storage, `properties/${fileName}`);
                try {
                    statusText.textContent = `Nahrávám obrázek ${i + 1} z ${files.length}...`;
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    imageUrls.push(url);
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                } catch (error) {
                    console.error("Chyba při nahrávání obrázku:", error);
                    statusText.textContent = `Chyba při nahrávání obrázku: ${file.name}`;
                }
            }
            return imageUrls;
        }

        // --- Page Management ---
        const pagesTableBody = document.getElementById('pages-table-body');
        const pageForm = document.getElementById('page-form');
        
        async function loadPages() {
            try {
                const pagesRef = collection(db, 'pages');
                const q = query(pagesRef, orderBy('title_cz'));
                const querySnapshot = await getDocs(q);
                pagesTableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const page = doc.data();
                    const statusClass = page.status === 'Aktivní' ? 'active' : 'inactive';
                    pagesTableBody.innerHTML += `
                        <tr id="page-${doc.id}">
                            <td class="table-cell font-bold">${page.title_cz}</td>
                            <td class="table-cell">/${page.slug}</td>
                            <td class="table-cell"><span class="status-toggle ${statusClass}">${page.status || 'Neaktivní'}</span></td>
                            <td class="table-cell">
                                <button class="edit-page-btn text-blue-600 hover:text-blue-900 mr-4" data-id="${doc.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-page-btn text-red-600 hover:text-red-900" data-id="${doc.id}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                handleFirestoreError(error, 'Načítání stránek');
            }
        }

        function resetPageForm() {
            pageForm.reset();
            document.getElementById('page-id').value = '';
            ['cz', 'en', 'de'].forEach(lang => {
                setEditorContent(`page-content-${lang}`, '');
            });
            document.getElementById('page-form-title').textContent = 'Přidat novou stránku';
        }

        document.getElementById('add-page-btn').addEventListener('click', () => {
            resetPageForm();
            showView('pageForm', 'pages');
        });
        document.getElementById('cancel-page-form-btn').addEventListener('click', () => showView('pageManagement', 'pages'));
        document.getElementById('page-title-cz').addEventListener('input', (e) => {
            document.getElementById('page-slug').value = slugify(e.target.value);
        });

        pageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('page-id').value;
            const pageData = {
                slug: document.getElementById('page-slug').value,
                status: document.getElementById('page-status').value,
                title_cz: document.getElementById('page-title-cz').value,
                content_cz: getEditorContent('page-content-cz'),
                title_en: document.getElementById('page-title-en').value,
                content_en: getEditorContent('page-content-en'),
                title_de: document.getElementById('page-title-de').value,
                content_de: getEditorContent('page-content-de'),
            };
            try {
                if (id) {
                    await updateDoc(doc(db, 'pages', id), pageData);
                } else {
                    await addDoc(collection(db, 'pages'), pageData);
                }
                showView('pageManagement', 'pages');
                loadPages();
            } catch (error) {
                handleFirestoreError(error, 'Ukládání stránky');
            }
        });

        pagesTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            if (button.classList.contains('delete-page-btn')) {
                if (confirm('Opravdu chcete smazat tuto stránku?')) {
                    try {
                        await deleteDoc(doc(db, 'pages', id));
                        loadPages();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání stránky');
                    }
                }
            }
            if (button.classList.contains('edit-page-btn')) {
                try {
                    const docRef = doc(db, 'pages', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const page = docSnap.data();
                        resetPageForm();
                        document.getElementById('page-id').value = id;
                        document.getElementById('page-slug').value = page.slug;
                        document.getElementById('page-status').value = page.status || 'Aktivní';
                        document.getElementById('page-title-cz').value = page.title_cz || '';
                        document.getElementById('page-title-en').value = page.title_en || '';
                        document.getElementById('page-title-de').value = page.title_de || '';
                        setEditorContent('page-content-cz', page.content_cz || '');
                        setEditorContent('page-content-en', page.content_en || '');
                        setEditorContent('page-content-de', page.content_de || '');
                        document.getElementById('page-form-title').textContent = 'Upravit stránku';
                        showView('pageForm', 'pages');
                    }
                } catch (error) {
                    handleFirestoreError(error, 'Editace stránky');
                }
            }
        });

        // --- Tag Management ---
        async function loadTags() {
            const container = document.getElementById('tags-list');
            container.innerHTML = '<p>Načítání tagů...</p>';
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                const settingsDocSnap = await getDoc(settingsDocRef);
                const tags = settingsDocSnap.exists() ? settingsDocSnap.data().tags || [] : [];
                renderTags(tags);
            } catch (error) {
                handleFirestoreError(error, 'Načítání tagů');
            }
        }

        function renderTags(tags) {
            const container = document.getElementById('tags-list');
            container.innerHTML = '';
            if (tags.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Zatím nebyly přidány žádné tagy.</p>';
                return;
            }
            tags.sort().forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                tagEl.innerHTML = `
                    <span class="flex-grow mr-4 break-all">${tag}</span>
                    <div class="flex-shrink-0">
                        <button class="edit-tag-btn text-blue-600 hover:text-blue-900 mr-3" data-tag="${tag}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-tag-btn text-red-500 hover:text-red-700" data-tag="${tag}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(tagEl);
            });
        }
        
        function resetTagForm() {
            const form = document.getElementById('form-tags');
            const input = document.getElementById('new-tag-input');
            const addBtn = document.getElementById('add-tag-btn');
            const cancelBtn = document.getElementById('cancel-edit-tag-btn');
            
            currentEditTag = null;
            input.value = '';
            addBtn.textContent = 'Přidat';
            cancelBtn.classList.add('hidden');
        }

        document.getElementById('form-tags').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-tag-input');
            const newTag = input.value.trim();
            if (!newTag) return;

            const settingsDocRef = doc(db, 'settings', 'global');
            try {
                const docSnap = await getDoc(settingsDocRef);
                let tags = docSnap.exists() ? docSnap.data().tags || [] : [];
                
                if (currentEditTag) { // Editing existing tag
                    const index = tags.indexOf(currentEditTag);
                    if (index > -1) {
                        tags[index] = newTag;
                    } else { // Failsafe if old tag not found
                        tags.push(newTag);
                    }
                    await updateDoc(settingsDocRef, { tags });
                } else { // Adding new tag
                     if (tags.includes(newTag)) {
                        alert('Tento tag již existuje.');
                        return;
                    }
                    await updateDoc(settingsDocRef, { tags: arrayUnion(newTag) });
                }
                resetTagForm();
                await loadTags();
            } catch (error) {
                handleFirestoreError(error, 'Ukládání SEO tagu');
            }
        });

        document.getElementById('tags-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const tag = button.dataset.tag;
            if (button.classList.contains('delete-tag-btn')) {
                if (confirm(`Opravdu chcete smazat tag "${tag}"?`)) {
                    try {
                        const settingsDocRef = doc(db, 'settings', 'global');
                        await updateDoc(settingsDocRef, { tags: arrayRemove(tag) });
                        await loadTags();
                    } catch (error) {
                        handleFirestoreError(error, 'Mazání SEO tagu');
                    }
                }
            } else if (button.classList.contains('edit-tag-btn')) {
                currentEditTag = tag;
                document.getElementById('new-tag-input').value = tag;
                document.getElementById('add-tag-btn').textContent = 'Uložit změny';
                document.getElementById('cancel-edit-tag-btn').classList.remove('hidden');
                document.getElementById('new-tag-input').focus();
            }
        });
        
        document.getElementById('cancel-edit-tag-btn').addEventListener('click', resetTagForm);

        // --- Settings Management ---
        const settingsTabs = document.getElementById('settings-tabs');
        
        settingsTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentSettingsCountry = e.target.dataset.country;
                settingsTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                loadAndRenderCountrySettings();
            }
        });

        function createSettingsForm(type, title, isMultiLang) {
            const formId = `form-${type}`;
            const inputs = isMultiLang 
                ? `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="new-${type}-cz-input" class="block text-sm font-medium text-gray-700">Název CZ</label>
                            <input type="text" id="new-${type}-cz-input" class="input-field mt-1" required>
                        </div>
                        <div>
                            <label for="new-${type}-en-input" class="block text-sm font-medium text-gray-700">Název EN</label>
                            <input type="text" id="new-${type}-en-input" class="input-field mt-1">
                        </div>
                        <div>
                            <label for="new-${type}-de-input" class="block text-sm font-medium text-gray-700">Název DE</label>
                            <input type="text" id="new-${type}-de-input" class="input-field mt-1">
                        </div>
                    </div>`
                : `
                    <div>
                        <label for="new-${type}-cz-input" class="block text-sm font-medium text-gray-700">Název</label>
                        <input type="text" id="new-${type}-cz-input" class="input-field mt-1" required>
                    </div>`;

            return `
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div id="${type}-list" class="mb-4 space-y-2"></div>
                    <form id="${formId}" class="space-y-4 p-4 border rounded-md">
                        <h4 id="${type}-form-title" class="font-bold text-lg">Přidat novou položku</h4>
                        ${inputs}
                        <div class="flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary w-full md:w-auto">Přidat</button>
                            <button type="button" class="btn btn-secondary hidden cancel-edit-btn">Zrušit úpravu</button>
                        </div>
                    </form>
                </div>`;
        }
        
        function renderCountrySettingsHTML(country) {
            const countryCapitalized = country.charAt(0).toUpperCase() + country.slice(1);
            
            let extraMenuHTML = '';
            if (country === 'bulharsko') { 
                extraMenuHTML = `
                    <div>
                        <h4 class="font-bold mb-2">Menu "O Bulharsku"</h4>
                        <div id="bulgaria-menu-list-bulharsko" class="mb-4 space-y-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-bulgaria-menu-title-bulharsko" placeholder="Název položky" class="input-field">
                            <select id="new-bulgaria-menu-link-bulharsko" class="input-field"></select>
                            <button data-menu-type="bulgaria" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                        </div>
                    </div>`;
            } else if (country === 'spanelsko') {
                extraMenuHTML = `
                    <div>
                        <h4 class="font-bold mb-2">Menu "O Španělsku"</h4>
                        <div id="spain-menu-list-spanelsko" class="mb-4 space-y-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-spain-menu-title-spanelsko" placeholder="Název položky" class="input-field">
                            <select id="new-spain-menu-link-spanelsko" class="input-field"></select>
                            <button data-menu-type="spain" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                        </div>
                    </div>`;
            }

            return `
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-xl font-bold mb-4">Nastavení pro ${countryCapitalized}</h3>
                    <form id="${country}-settings-form">
                        <div class="mb-4">
                            <label for="setting-logo-text-${country}" class="block text-gray-700 font-bold mb-2">Text loga</label>
                            <input type="text" id="setting-logo-text-${country}" class="input-field">
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="submit" class="btn btn-primary">Uložit nastavení pro ${countryCapitalized}</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-xl font-bold mb-4">Správa menu pro ${countryCapitalized}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <h4 class="font-bold mb-2">Menu "Informace"</h4>
                            <div id="info-menu-list-${country}" class="mb-4 space-y-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-info-menu-title-${country}" placeholder="Název položky" class="input-field">
                                <select id="new-info-menu-link-${country}" class="input-field"></select>
                                <button data-menu-type="info" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-2">Menu "Naše služby"</h4>
                            <div id="services-menu-list-${country}" class="mb-4 space-y-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="new-services-menu-title-${country}" placeholder="Název položky" class="input-field">
                                <select id="new-services-menu-link-${country}" class="input-field"></select>
                                <button data-menu-type="services" class="add-menu-item-btn btn btn-primary whitespace-nowrap">Přidat</button>
                            </div>
                        </div>
                        ${extraMenuHTML}
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    ${createSettingsForm('locations', 'Správa Lokalit', false)}
                    ${createSettingsForm('types', 'Správa Druhů Nemovitostí', true)}
                    ${createSettingsForm('rooms', 'Správa Dispozic', true)}
                </div>
            `;
        }
        
        async function loadAndRenderCountrySettings() {
            const container = document.getElementById('country-specific-settings-container');
            const country = currentSettingsCountry;
            try {
                const settingsDocRef = doc(db, 'settings', country);
                const settingsDocSnap = await getDoc(settingsDocRef);
                const settings = settingsDocSnap.exists() ? settingsDocSnap.data() : {};
                
                container.innerHTML = renderCountrySettingsHTML(country);
                
                document.getElementById(`setting-logo-text-${country}`).value = settings.logoText || '';
                
                const pagesSnapshot = await getDocs(collection(db, 'pages'));
                const menuSelects = [
                    document.getElementById(`new-info-menu-link-${country}`),
                    document.getElementById(`new-services-menu-link-${country}`),
                    document.getElementById(`new-bulgaria-menu-link-${country}`),
                    document.getElementById(`new-spain-menu-link-${country}`)
                ].filter(Boolean);

                menuSelects.forEach(select => select.innerHTML = '<option value="">-- Vyberte stránku --</option>');
                
                pagesSnapshot.forEach(doc => {
                    const page = doc.data();
                    const option = new Option(`${page.title_cz} (${page.status === 'Aktivní' ? '✓' : '✗'})`, page.slug);
                    if (page.status !== 'Aktivní') {
                        option.disabled = true;
                        option.style.color = '#ccc';
                    }
                    menuSelects.forEach(select => select.add(option.cloneNode(true)));
                });
                
                renderMenuItems('info', settings.infoMenu || []);
                renderMenuItems('services', settings.servicesMenu || []);
                if (country === 'bulharsko') renderMenuItems('bulgaria', settings.bulgariaMenu || []);
                if (country === 'spanelsko') renderMenuItems('spain', settings.spainMenu || []);
                
                renderList('locations', settings.locations || [], 'form-locations');
                renderList('types', settings.types || [], 'form-types');
                renderList('rooms', settings.rooms || [], 'form-rooms');

                // Attach listeners for dynamically created forms
                document.querySelectorAll('#form-locations, #form-types, #form-rooms').forEach(form => {
                    form.addEventListener('submit', handleSettingsFormSubmit);
                });
                document.querySelectorAll('#locations-list, #types-list, #rooms-list').forEach(list => {
                    list.addEventListener('click', handleSettingsItemClick);
                });

            } catch (error) {
                handleFirestoreError(error, `Načítání nastavení pro ${country}`);
            }
        }

        async function loadGlobalSettings() {
            try {
                const docRef = doc(db, 'settings', 'global');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('setting-contact1-name').value = data.contact1_name || '';
                    document.getElementById('setting-contact1-phone').value = data.contact1_phone || '';
                    document.getElementById('setting-contact1-phone2').value = data.contact1_phone2 || '';
                    document.getElementById('setting-contact1-email').value = data.contact1_email || '';
                    document.getElementById('setting-contact2-name').value = data.contact2_name || '';
                    document.getElementById('setting-contact2-phone').value = data.contact2_phone || '';
                    document.getElementById('setting-contact2-phone2').value = data.contact2_phone2 || '';
                    document.getElementById('setting-contact2-email').value = data.contact2_email || '';
                    renderList('features', data.features || [], 'form-features');
                }
            } catch (error) {
                handleFirestoreError(error, 'Načítání globálních nastavení');
            }
        }

        document.getElementById('global-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Ukládám...';
            try {
                const data = {
                    contact1_name: document.getElementById('setting-contact1-name').value,
                    contact1_phone: document.getElementById('setting-contact1-phone').value,
                    contact1_phone2: document.getElementById('setting-contact1-phone2').value,
                    contact1_email: document.getElementById('setting-contact1-email').value,
                    contact2_name: document.getElementById('setting-contact2-name').value,
                    contact2_phone: document.getElementById('setting-contact2-phone').value,
                    contact2_phone2: document.getElementById('setting-contact2-phone2').value,
                    contact2_email: document.getElementById('setting-contact2-email').value,
                };
                await setDoc(doc(db, 'settings', 'global'), data, { merge: true });
                alert('Globální kontakty byly uloženy.');
            } catch (error) {
                handleFirestoreError(error, 'Ukládání globálních kontaktů');
            } finally {
                button.disabled = false;
                button.textContent = 'Uložit globální kontakty';
            }
        });
        
        function resetForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            form.reset();
            const title = form.querySelector('h4');
            const submitBtn = form.querySelector('button[type="submit"]');
            const cancelBtn = form.querySelector('.cancel-edit-btn');

            if (title) title.textContent = 'Přidat novou položku';
            if (submitBtn) {
                submitBtn.textContent = 'Přidat';
            }
            if (cancelBtn) cancelBtn.classList.add('hidden');
            currentEditItem = { type: null, key: null };
        }

        async function handleSettingsFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.id.split('-')[1];
            const isGlobal = type === 'features';
            const docId = isGlobal ? 'global' : currentSettingsCountry;
            const arrayName = type;

            const czInput = form.querySelector(`#new-${type}-cz-input`);
            const enInput = form.querySelector(`#new-${type}-en-input`);
            const deInput = form.querySelector(`#new-${type}-de-input`);

            const name_cz = czInput.value.trim();
            if (!name_cz) {
                alert('Český název je povinný.');
                return;
            }

            const key = currentEditItem.key || slugify(name_cz);
            let newItemData;
            if (enInput) { // Multilang object
                newItemData = { key, name_cz, name_en: enInput.value.trim(), name_de: deInput.value.trim() };
            } else { // Simple string (for locations)
                newItemData = name_cz;
            }
            
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                const settingsDocRef = doc(db, 'settings', docId);
                const docSnap = await getDoc(settingsDocRef);
                let items = (docSnap.exists() && docSnap.data()[arrayName]) ? docSnap.data()[arrayName] : [];

                if (currentEditItem.key) { // UPDATE
                    submitButton.textContent = 'Ukládám...';
                    const itemIndex = items.findIndex(item => (typeof item === 'object' ? item.key : slugify(item)) === currentEditItem.key);
                    if (itemIndex > -1) {
                        items[itemIndex] = newItemData;
                    } else { // Failsafe if not found, add it
                        items.push(newItemData);
                    }
                } else { // ADD
                    submitButton.textContent = 'Přidávám...';
                    const itemExists = items.some(item => (typeof item === 'object' ? item.key : slugify(item)) === key);
                    if (itemExists) {
                        alert('Položka s tímto názvem již existuje. Zvolte jiný název.');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Přidat';
                        return;
                    }
                    items.push(newItemData);
                }
                
                await setDoc(settingsDocRef, { [arrayName]: items }, { merge: true });
                resetForm(form.id);
                isGlobal ? await loadGlobalSettings() : await loadAndRenderCountrySettings();

            } catch (error) {
                handleFirestoreError(error, currentEditItem.key ? 'Úprava položky' : 'Přidání položky');
            } finally {
                submitButton.disabled = false;
            }
        }

        document.getElementById('settings-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            // --- General Edit/Delete Handlers ---
            if (button.classList.contains('edit-setting-item-btn')) {
                // This needs to be delegated here because these buttons are created dynamically
                await handleSettingsItemClick(e);
                return;
            }
            if (button.classList.contains('delete-setting-item-btn')) {
                await handleSettingsItemClick(e);
                return;
            }

            if(button.classList.contains('cancel-edit-btn')) {
                resetForm(button.closest('form').id);
                return;
            }
            
            // --- Menu Specific Handlers ---
            if (button.closest('form')?.id === `${currentSettingsCountry}-settings-form`) {
                e.preventDefault();
                button.disabled = true;
                button.textContent = 'Ukládám...';
                try {
                    const data = {
                        logoText: document.getElementById(`setting-logo-text-${currentSettingsCountry}`).value,
                    };
                    await setDoc(doc(db, 'settings', currentSettingsCountry), data, { merge: true });
                    alert(`Nastavení pro ${currentSettingsCountry} bylo uloženo.`);
                } catch (error) {
                    handleFirestoreError(error, `Ukládání nastavení pro ${currentSettingsCountry}`);
                } finally {
                    button.disabled = false;
                    button.textContent = `Uložit nastavení pro ${currentSettingsCountry}`;
                }
                return;
            }
            
            if (button.classList.contains('add-menu-item-btn')) {
                e.preventDefault();
                const menuType = button.dataset.menuType;
                const titleInput = document.getElementById(`new-${menuType}-menu-title-${currentSettingsCountry}`);
                const linkSelect = document.getElementById(`new-${menuType}-menu-link-${currentSettingsCountry}`);
                const title = titleInput.value.trim();
                const slug = linkSelect.value;
                
                if (!title || !slug) {
                    alert('Prosím vyplňte název i odkaz.');
                    return;
                }
                
                const value = { title, slug };
                const arrayName = `${menuType}Menu`;
                
                try {
                    await setDoc(doc(db, 'settings', currentSettingsCountry), {
                        [arrayName]: arrayUnion(value)
                    }, { merge: true });
                    titleInput.value = '';
                    linkSelect.value = '';
                    await loadAndRenderCountrySettings();
                } catch (error) {
                    handleFirestoreError(error, `Přidání položky do menu ${menuType}`);
                }
                return;
            }

            if (button.classList.contains('delete-menu-item-btn')) {
                e.preventDefault();
                const menuType = button.dataset.menuType;
                const title = button.dataset.title;
                const slug = button.dataset.slug;
                const itemToRemove = { title, slug };
                const arrayName = `${menuType}Menu`;

                if (confirm(`Opravdu chcete smazat položku menu "${title}"?`)) {
                    try {
                        await updateDoc(doc(db, 'settings', currentSettingsCountry), {
                            [arrayName]: arrayRemove(itemToRemove)
                        });
                        await loadAndRenderCountrySettings();
                    } catch (error) {
                        handleFirestoreError(error, `Mazání položky z menu ${menuType}`);
                    }
                }
                return;
            }
        });
        
        // Separate handlers for features because they are static in DOM
        document.getElementById('form-features').addEventListener('submit', handleSettingsFormSubmit);
        document.getElementById('features-list').addEventListener('click', handleSettingsItemClick);

        async function handleSettingsItemClick(e) {
             const btn = e.target.closest('button');
             if(!btn) return;
             const type = btn.dataset.type;
             const key = btn.dataset.key;
             const isGlobal = type === 'features';
             const docId = isGlobal ? 'global' : currentSettingsCountry;
             const docRef = doc(db, 'settings', docId);

             if(btn.classList.contains('delete-setting-item-btn')) {
                 e.preventDefault();
                 if(confirm('Opravdu chcete smazat tuto položku?')) {
                     try {
                         const snap = await getDoc(docRef);
                         if (!snap.exists()) return;
                         
                         const data = snap.data();
                         let items = data[type] || [];
                         const itemToRemove = items.find(i => (typeof i==='object'?i.key:slugify(i)) === key);
                         
                         if(itemToRemove) {
                             await updateDoc(docRef, {[type]: arrayRemove(itemToRemove)});
                             isGlobal ? await loadGlobalSettings() : await loadAndRenderCountrySettings();
                         }
                     } catch (error) {
                         handleFirestoreError(error, 'Mazání položky');
                     }
                 }
             } else if(btn.classList.contains('edit-setting-item-btn')) {
                 e.preventDefault();
                 const formId = btn.dataset.formId;
                 const form = document.getElementById(formId);
                 
                 // Scroll to form
                 form.scrollIntoView({ behavior: 'smooth' });

                 try {
                     const snap = await getDoc(docRef);
                     if (!snap.exists()) return;
                     
                     let items = snap.data()[type] || [];
                     const item = items.find(i => (typeof i==='object'?i.key:slugify(i)) === key);
                     
                     if(item) {
                         currentEditItem = {type, key};
                         form.querySelector(`#new-${type}-cz-input`).value = typeof item==='object' ? item.name_cz : item;
                         
                         const enInput = form.querySelector(`#new-${type}-en-input`);
                         if(enInput && typeof item==='object') enInput.value = item.name_en||'';
                         
                         const deInput = form.querySelector(`#new-${type}-de-input`);
                         if(deInput && typeof item==='object') deInput.value = item.name_de||'';
                         
                         const title = form.querySelector('h4');
                         if (title) title.textContent = 'Upravit položku';
                         
                         const submitBtn = form.querySelector('button[type="submit"]');
                         if(submitBtn) submitBtn.textContent = 'Uložit změny';
                         
                         const cancelBtn = form.querySelector('.cancel-edit-btn');
                         if(cancelBtn) cancelBtn.classList.remove('hidden');
                     }
                 } catch (error) {
                     handleFirestoreError(error, 'Načítání položky pro úpravu');
                 }
             }
        }

        function setupTabSwitching(tabsId, contentClass) {
            const tabsContainer = document.getElementById(tabsId);
            if (!tabsContainer) return;
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const lang = e.target.dataset.lang;
                    tabsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll(`.${contentClass}`).forEach(content => {
                        if (content.id.includes(`-${lang}`)) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                }
            });
        }
        setupTabSwitching('property-lang-tabs', 'lang-tab-content');
        setupTabSwitching('page-lang-tabs', 'lang-tab-content');

        // Defining functions like populateFormDropdowns and populateFeatures
        async function populateFormDropdowns(country, propertyData = {}) {
            const selects = {
                location: document.getElementById('property-location'),
                type: document.getElementById('property-type'),
                rooms: document.getElementById('property-rooms')
            };
            Object.values(selects).forEach(s => s.innerHTML = '<option value="">Načítání...</option>');
            
            try {
                const settingsDocRef = doc(db, 'settings', country);
                const settingsDocSnap = await getDoc(settingsDocRef);
                
                if (!settingsDocSnap.exists()) { 
                    Object.values(selects).forEach(s => s.innerHTML = '<option value="">Žádná data pro tuto zemi</option>');
                     return;
                }
                const settings = settingsDocSnap.data();

                const populateSelect = (selectElement, items, selectedValue) => {
                    selectElement.innerHTML = `<option value="">-- Vyberte --</option>`;
                    
                    if (!Array.isArray(items)) return;

                    const getName = (item) => (typeof item === 'object' && item !== null) ? item.name_cz : item;

                    items
                        .filter(item => getName(item))
                        .sort((a, b) => getName(a).localeCompare(getName(b), 'cs'))
                        .forEach(item => {
                            const value = getName(item);
                            const option = new Option(value, value);
                            if (value === selectedValue) option.selected = true;
                            selectElement.add(option);
                        });
                };
                
                populateSelect(selects.location, settings.locations || [], propertyData.location);
                populateSelect(selects.type, settings.types || [], propertyData.type);
                populateSelect(selects.rooms, settings.rooms || [], propertyData.rooms);

            } catch (error) {
                console.error("Chyba při načítání nastavení pro formulář:", error);
                Object.values(selects).forEach(s => s.innerHTML = '<option value="">Chyba načítání</option>');
            }
        }

        async function populateFeatures(selectedFeatures = []) {
            const container = document.getElementById('features-container');
            container.innerHTML = '';
            try {
                const settingsDocRef = doc(db, 'settings', 'global');
                const settingsDocSnap = await getDoc(settingsDocRef);
                const settings = settingsDocSnap.exists() ? settingsDocSnap.data() : { features: [] };
                (settings.features || []).sort((a,b) => (a.name_cz || '').localeCompare(b.name_cz || '', 'cs')).forEach(feature => {
                    const checked = selectedFeatures.includes(feature.key) ? 'checked' : '';
                    container.innerHTML += `
                        <div class="feature-item">
                            <input type="checkbox" id="feature-${feature.key}" value="${feature.key}" ${checked} class="feature-checkbox">
                            <label for="feature-${feature.key}">${feature.name_cz}</label>
                        </div>`;
                });
            } catch (error) {
                console.error("Chyba při načítání vlastností:", error);
                container.innerHTML = '<p>Chyba při načítání vlastností.</p>';
            }
        }

        // This ensures the listener for the add button works because openNewPropertyForm uses populateFormDropdowns which is now defined.
        
    </script>
</body>
</html>
